---
import "../styles/global.css";
import TopBar from "../components/TopBar.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import CookieBanner from "../components/CookieBanner.astro";
import MobileFloatingCTA from "../components/MobileFloatingCTA.astro";
import ExitIntentPopup from "../components/ExitIntentPopup.astro";
import { SITE_CONFIG } from "../config/site";

import "@fontsource/manrope/latin.css";
import "@fontsource/outfit/latin.css";

import { generateSpeakableSchema } from "../utils/seo";

interface Props {
	title: string;
	description?: string;
	ogImage?: string;
	ogImageAlt?: string;
	ogType?: "website" | "article";
	canonical?: string;
	noindex?: boolean;
	speakableSelectors?: string[];
	topBarDark?: boolean;
}

const {
	title,
	description = "24/7 Professional Electrical Services in Miami",
	ogImage,
	ogImageAlt,
	ogType = "website",
	canonical,
	noindex = false,
	speakableSelectors = [
		".section-title",
		".section-description",
		".seo-body",
	],
	topBarDark = false,
} = Astro.props;

// Generate canonical URL - use provided or construct from current path
const siteUrl = SITE_CONFIG.seo.siteUrl;
const canonicalURL = canonical || new URL(Astro.url.pathname, siteUrl).href;

// Ensure OG image is always an absolute URL (social platforms require this)
const rawOgImage = ogImage || `${siteUrl}/og-default.webp`;
const ogImageURL = rawOgImage.startsWith("http")
	? rawOgImage
	: `${siteUrl}${rawOgImage}`;
const ogImageAltText = ogImageAlt || title;

// Generate Speakable Schema
const speakableSchema = generateSpeakableSchema(
	canonicalURL,
	speakableSelectors,
);
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<!-- Critical inline style for instant render + FOUC prevention -->
		<style>
			html:not(.css-loaded) body {
				opacity: 0;
			}
			body {
				margin: 0;
				min-height: 100vh;
				display: flex;
				flex-direction: column;
				background-color: var(--bg-body);
				font-family: var(--font-body);
				color: var(--clr-primary);
			}
			header {
				min-height: 70px;
				background-color: #fff;
			}
			main {
				flex-grow: 1;
			}
			.container-wrapper {
				width: 100%;
				max-width: var(--container-max);
				margin: 0 auto;
				padding-left: clamp(
					var(--container-padding-sm),
					4vw,
					var(--container-padding-md)
				);
				padding-right: clamp(
					var(--container-padding-sm),
					4vw,
					var(--container-padding-md)
				);
			}
			@media (min-width: 1024px) {
				header {
					min-height: 100px;
				}
			}
		</style>
		<script is:inline>
			// Optimized FOUC prevention using requestAnimationFrame
			(function () {
				const setLoaded = () =>
					document.documentElement.classList.add("css-loaded");
				if (document.fonts && document.fonts.ready) {
					document.fonts.ready.then(setLoaded).catch(setLoaded);
				} else {
					setLoaded();
				}
				// Fail-safe
				setTimeout(setLoaded, 1000);
			})();
		</script>

		<meta name="description" content={description} />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover"
		/>

		<!-- Google Tag Manager (GTM) - Optimized Loading -->
		<script id="gtm-init" is:inline>
			window.dataLayer = window.dataLayer || [];
		</script>
		<script
			async
			src={`https://www.googletagmanager.com/gtm.js?id=${SITE_CONFIG.seo.tracking.gtm}`}
			id="gtm-script"></script>

		<!-- Performance: Critical resource hints for faster connection to key domains -->
		<link rel="preconnect" href="https://www.googletagmanager.com" />
		<link rel="dns-prefetch" href="https://www.google-analytics.com" />
		<link rel="preconnect" href="https://maps.googleapis.com" />
		<link rel="dns-prefetch" href="https://maps.gstatic.com" />
		<link rel="preconnect" href="https://api.smtp2go.com" />

		<!-- Fonts loaded via @fontsource imports -->

		<!-- Preload critical fonts for faster LCP -->
		<link
			rel="preload"
			href="/fonts/LEMONMILK-Regular.woff2"
			as="font"
			type="font/woff2"
			crossorigin
		/>
		<link
			rel="preload"
			href="https://cdn.jsdelivr.net/fontsource/fonts/outfit@latest/latin-900-normal.woff2"
			as="font"
			type="font/woff2"
			crossorigin
		/>
		<link
			rel="preload"
			href="https://cdn.jsdelivr.net/fontsource/fonts/manrope@latest/latin-400-normal.woff2"
			as="font"
			type="font/woff2"
			crossorigin
		/>

		<link rel="icon" type="image/png" href="/favicon.png" />
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		<meta
			name="theme-color"
			content={SITE_CONFIG.company.branding.primary}
		/>

		<!-- Mobile Meta -->
		<meta name="format-detection" content="telephone=yes" />

		<meta name="generator" content={Astro.generator} />

		<!-- Canonical URL -->
		<link rel="canonical" href={canonicalURL} />

		<!-- Robots -->
		{
			noindex ? (
				<meta name="robots" content="noindex, nofollow" />
			) : (
				<meta
					name="robots"
					content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
				/>
			)
		}

		<title>{title}</title>

		<!-- Speakable Schema for Voice AI -->
		<script
			type="application/ld+json"
			set:html={JSON.stringify(speakableSchema)}
		/>

		<!-- Open Graph -->
		<meta property="og:type" content={ogType} />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={ogImageURL} />
		<meta property="og:image:alt" content={ogImageAltText} />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:locale" content="en_US" />
		<meta
			property="og:site_name"
			content={SITE_CONFIG.company.name.replace(/&/g, "&amp;")}
		/>

		<!-- Twitter Card -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@solomonelectric" />
		<meta name="twitter:creator" content="@solomonelectric" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={ogImageURL} />
		<meta name="twitter:image:alt" content={ogImageAltText} />

		<!-- Local Business Info (for rich snippets) -->
		<meta name="geo.region" content="US-FL" />
		<meta name="geo.placename" content={SITE_CONFIG.contact.address.city} />
		<meta
			name="geo.position"
			content={`${SITE_CONFIG.seo.schema.latitude};${SITE_CONFIG.seo.schema.longitude}`}
		/>
		<meta
			name="ICBM"
			content={`${SITE_CONFIG.seo.schema.latitude}, ${SITE_CONFIG.seo.schema.longitude}`}
		/>

		<!-- Allow additional head content via slots -->
		<slot name="head" />
	</head>

	<body
		class="bg-[var(--bg-body)] text-[var(--clr-primary)] flex flex-col min-h-screen font-body selection:bg-[var(--bg-accent)] selection:text-[var(--clr-inverse)]"
	>
		<!-- Google Tag Manager (noscript) -->
		<noscript
			><iframe
				src={`https://www.googletagmanager.com/ns.html?id=${SITE_CONFIG.seo.tracking.gtm}`}
				height="0"
				width="0"
				style="display:none;visibility:hidden"
				title="Google Tag Manager (noscript)"></iframe></noscript
		>
		<!-- End Google Tag Manager (noscript) -->

		<!-- Skip Navigation Link for Accessibility -->
		<a href="#main-content" class="skip-to-content">Skip to main content</a>

		<TopBar isDark={topBarDark} />
		<Header />

		<main id="main-content" class="flex-grow">
			<slot />
		</main>
		<Footer />
		<MobileFloatingCTA />
		<CookieBanner />
		<ExitIntentPopup />
		<script is:inline>
			// Scroll Reveal System - Intersection Observer (scoped to avoid conflicts)
			(function () {
				const observerOptions = {
					root: null,
					threshold: 0.1,
					rootMargin: "0px 0px -50px 0px",
				};

				const observer = new IntersectionObserver((entries) => {
					entries.forEach((entry) => {
						if (entry.isIntersecting) {
							entry.target.classList.add("reveal-active");
							// Optional: stop observing after reveal
							// observer.unobserve(entry.target);
						}
					});
				}, observerOptions);

				function initScrollReveal() {
					const revealElements = document.querySelectorAll(".reveal");
					revealElements.forEach((el) => observer.observe(el));
				}

				// Initialize on page load
				document.addEventListener("DOMContentLoaded", initScrollReveal);

				// Initialize after Astro page transitions (if using View Transitions)
				document.addEventListener("astro:after-swap", initScrollReveal);
			})();
		</script>

		<script is:inline>
			// Session & UTM tracking initialization
			(function () {
				if (!sessionStorage.getItem("sessionStart")) {
					sessionStorage.setItem(
						"sessionStart",
						Date.now().toString(),
					);
				}

				// Capture UTM parameters on first visit
				const params = new URLSearchParams(window.location.search);
				["utm_source", "utm_medium", "utm_campaign", "gclid"].forEach(
					(param) => {
						const value = params.get(param);
						if (value && !sessionStorage.getItem(param)) {
							sessionStorage.setItem(param, value);
						}
					},
				);

				// Track click path
				const path = sessionStorage.getItem("clickPath") || "";
				const currentPath = window.location.pathname;
				if (!path.includes(currentPath)) {
					sessionStorage.setItem(
						"clickPath",
						path + (path ? " > " : "") + currentPath,
					);
				}
			})();
		</script>

		<!-- Enhanced Analytics Tracking -->
		<script>
			import { initAllTracking } from "../utils/enhanced-tracking";
			initAllTracking();
		</script>
	</body>
</html>
