---
import Button from "./Button.astro";
import { Phone, Calendar } from "lucide-astro";
import { SITE_CONFIG } from "../../config/site";
import PhoneNumber from "./PhoneNumber.astro";

interface Props {
  action: "call" | "book" | "schedule";
  variant?: "primary" | "secondary" | "icon";
  size?: "lg" | "md" | "sm";
  class?: string;
  text?: string;
  [x: string]: any;
}

const {
  action,
  variant = "primary",
  size = "md",
  class: className = "",
  text,
  ...rest
} = Astro.props;

const isCall = action === "call";
const href = isCall
  ? SITE_CONFIG.contact.phone.href
  : SITE_CONFIG.contact.bookingUrl;

// Default text based on action if not provided
const defaultLabel = isCall
  ? `Call ${SITE_CONFIG.contact.phone.formatted.replace(/\u00A0/g, "&nbsp;").replace(/\u2011/g, "&#8209;")}`
  : "Schedule Service";
const label = text
  ? isCall
    ? text.replace(/ /g, "&nbsp;")
    : text
  : defaultLabel;
---

<Button
  href={href}
  variant={variant}
  size={size}
  class={`gap-2 ${className}`}
  data-cta-type={isCall ? "phone_click" : "book_click"}
  {...rest}
  >{isCall ? <Phone class="w-5 h-5" /> : <Calendar class="w-5 h-5" />}{
    isCall && !text ? <PhoneNumber /> : label
  }</Button
>

<script>
  // Track CTA button clicks in GTM dataLayer
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    const ctaButton = target.closest("[data-cta-type]");
    if (ctaButton) {
      const ctaType = ctaButton.getAttribute("data-cta-type");
      if (typeof window !== "undefined" && window.dataLayer) {
        window.dataLayer.push({
          event: ctaType as string,
          element_text: ctaButton.textContent?.trim() || "Unknown",
        });
      }
    }
  });
</script>
