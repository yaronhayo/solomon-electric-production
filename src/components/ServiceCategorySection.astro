---
/**
 * ServiceCategorySection.astro
 * Category section with SEO-optimized description and compact service list
 */
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import ServiceListItem from "./ServiceListItem.astro";
import CtaButton from "./ui/CtaButton.astro";
import { ChevronDown } from "lucide-astro";

interface Service {
    name: string;
    slug: string;
    shortDescription?: string;
    order: number;
}

interface CategoryInfo {
    name: string;
    description: string;
    image: ImageMetadata;
    icon: any;
}

interface Props {
    category: string;
    categoryInfo: CategoryInfo;
    services: Service[];
    initialCount?: number;
}

const { category, categoryInfo, services, initialCount = 5 } = Astro.props;

// Sort services by order
const sortedServices = services.sort((a, b) => a.order - b.order);
const initialServices = sortedServices.slice(0, initialCount);
const remainingServices = sortedServices.slice(initialCount);
const hasMore = remainingServices.length > 0;

// Generate unique ID for this section
const sectionId = category.toLowerCase().replace(/[^a-z0-9]+/g, "-");

// ImageMetadata comes from Astro imports, no need to redefine
---

<section
    class="category-section bg-[var(--bg-surface)] rounded-[var(--radius-xl)] overflow-hidden shadow-[var(--shadow-md)] hover:shadow-[var(--shadow-lg)] transition-shadow duration-300"
    id={sectionId}
    data-category={category}
>
    <!-- Category Header with Image -->
    <div class="relative h-36 sm:h-44 md:h-52 lg:h-56 overflow-hidden">
        <Image
            src={categoryInfo.image}
            alt={category}
            class="w-full h-full object-cover"
            loading="lazy"
        />
        <div
            class="absolute inset-0 bg-gradient-to-r from-primary/95 via-primary/85 to-primary/60"
        >
        </div>
        <div
            class="absolute inset-0 flex items-center p-5 sm:p-6 md:p-8 lg:p-10"
        >
            <div class="max-w-4xl">
                <h2
                    class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-black text-white uppercase tracking-tight mb-2 md:mb-3"
                >
                    {category}
                </h2>
                <p
                    class="text-white/90 text-sm md:text-base lg:text-lg font-medium leading-relaxed line-clamp-2 md:line-clamp-3"
                >
                    {categoryInfo.description}
                </p>
            </div>
        </div>
    </div>

    <!-- Services List -->
    <div class="p-5 sm:p-6 md:p-8 lg:p-10">
        <!-- Two-column grid on larger screens for better use of space -->
        <div class="services-list grid grid-cols-1 lg:grid-cols-2 gap-x-8">
            {
                initialServices.map((service) => (
                    <ServiceListItem service={service} showDescription={true} />
                ))
            }
        </div>

        {
            hasMore && (
                <div
                    class="expandable-services hidden grid grid-cols-1 lg:grid-cols-2 gap-x-8"
                    data-expanded="false"
                >
                    {remainingServices.map((service) => (
                        <ServiceListItem
                            service={service}
                            showDescription={true}
                        />
                    ))}
                </div>
            )
        }

        {/* Actions Row */}
        <div
            class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-4 mt-6 pt-6 border-t border-[var(--border-light)]"
        >
            {
                hasMore && (
                    <button
                        type="button"
                        class="expand-btn text-accent font-bold text-sm uppercase tracking-wider hover:text-primary transition-colors flex items-center gap-2"
                        data-section={sectionId}
                        aria-expanded="false"
                    >
                        <span class="expand-text">
                            Show {remainingServices.length} More Services
                        </span>
                        <ChevronDown class="expand-icon w-4 h-4 transition-transform" />
                    </button>
                )
            }

            <CtaButton
                variant="primary"
                action="book"
                text="Request Quote"
                class="sm:ml-auto"
            />
        </div>
    </div>
</section>

<script>
    // Handle expand/collapse for service lists
    document.querySelectorAll(".expand-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
            const button = btn as HTMLElement;
            const sectionId = button.getAttribute("data-section");
            const section = sectionId
                ? document.getElementById(sectionId)
                : null;
            const expandable = section?.querySelector(
                ".expandable-services",
            ) as HTMLElement | null;
            const expandText = button.querySelector(".expand-text");
            const expandIcon = button.querySelector(
                ".expand-icon",
            ) as HTMLElement | null;
            const isExpanded = button.getAttribute("aria-expanded") === "true";

            if (expandable && expandText && expandIcon) {
                if (isExpanded) {
                    expandable.classList.add("hidden");
                    button.setAttribute("aria-expanded", "false");
                    expandText.textContent = `Show ${expandable.children.length} More Services`;
                    expandIcon.style.transform = "rotate(0deg)";
                } else {
                    expandable.classList.remove("hidden");
                    button.setAttribute("aria-expanded", "true");
                    expandText.textContent = "Show Less";
                    expandIcon.style.transform = "rotate(180deg)";
                }
            }
        });
    });
</script>

<style>
    .category-section {
        scroll-margin-top: 100px;
    }
</style>
