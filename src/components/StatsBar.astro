---
/**
 * StatsBar Component
 * Displays animated statistics in a horizontal bar
 */
import Container from "./ui/Container.astro";

interface StatItem {
    value: string;
    label: string;
}

interface Props {
    stats: StatItem[];
}

const { stats } = Astro.props;
---

<section class="stats-bar">
    <Container>
        <div class="stats-grid">
            {
                stats.map((stat, index) => {
                    // Check if value is a simple number with optional trailing suffix (like "15+", "2,500+", "100%")
                    const simpleMatch = stat.value.match(/^([0-9,]+)([+%]?)$/);
                    const isAnimatable = simpleMatch !== null;
                    const numericValue = isAnimatable
                        ? parseInt(simpleMatch[1].replace(/,/g, ""))
                        : 0;
                    const suffix = isAnimatable ? simpleMatch[2] : "";

                    return (
                        <div class="stat-item">
                            <div class="stat-glow" />
                            {isAnimatable ? (
                                <span
                                    class="stat-value stat-counter"
                                    data-target={numericValue}
                                    data-suffix={suffix}
                                >
                                    0{suffix}
                                </span>
                            ) : (
                                <span class="stat-value">{stat.value}</span>
                            )}
                            <span class="stat-label">{stat.label}</span>
                            {index < stats.length - 1 && (
                                <div class="stat-divider" />
                            )}
                        </div>
                    );
                })
            }
        </div>
    </Container>
</section>

<style>
    .stats-bar {
        background: linear-gradient(
            135deg,
            var(--color-primary) 0%,
            #061f3d 100%
        );
        padding: clamp(1.5rem, 3vw, 2.5rem) 0;
        position: relative;
        overflow: hidden;
    }

    .stats-bar::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
            90deg,
            transparent 0%,
            rgba(20, 211, 227, 0.1) 50%,
            transparent 100%
        );
        animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
        0%,
        100% {
            transform: translateX(-100%);
        }
        50% {
            transform: translateX(100%);
        }
    }

    .stats-grid {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: clamp(2rem, 4vw, 4rem);
        position: relative;
    }

    .stat-item {
        position: relative;
        text-align: center;
        padding: 0 clamp(1rem, 2vw, 2rem);
    }

    .stat-glow {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background: radial-gradient(
            circle,
            rgba(20, 211, 227, 0.3) 0%,
            transparent 70%
        );
        filter: blur(20px);
        opacity: 0;
        transition: opacity var(--transition-base);
    }

    .stat-item:hover .stat-glow {
        opacity: 1;
    }

    .stat-value {
        display: block;
        font-family: var(--font-display);
        font-size: clamp(2rem, 5vw, 3rem);
        font-weight: 800;
        color: var(--color-accent);
        line-height: 1;
        text-shadow: 0 0 30px rgba(20, 211, 227, 0.5);
        position: relative;
    }

    .stat-label {
        display: block;
        font-family: var(--font-secondary);
        font-size: clamp(0.7rem, 1vw, 0.8rem);
        color: rgba(255, 255, 255, 0.85);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .stat-divider {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 1px;
        height: 40px;
        background: linear-gradient(
            180deg,
            transparent 0%,
            var(--color-accent) 50%,
            transparent 100%
        );
    }
</style>

<script>
    const observerOptions = { root: null, rootMargin: "0px", threshold: 0.1 };

    const animateStats = () => {
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const counter = entry.target as HTMLElement;
                    const target = parseInt(
                        counter.getAttribute("data-target") || "0",
                    );
                    const suffix = counter.getAttribute("data-suffix") || "";
                    const duration = 2000;
                    const startTime = performance.now();

                    const updateCount = (currentTime: number) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        const easeOut = 1 - Math.pow(1 - progress, 4);
                        const current = Math.floor(easeOut * target);
                        counter.innerText = current.toLocaleString() + suffix;
                        if (progress < 1) {
                            requestAnimationFrame(updateCount);
                        } else {
                            counter.innerText =
                                target.toLocaleString() + suffix;
                        }
                    };

                    requestAnimationFrame(updateCount);
                    observer.unobserve(counter);
                }
            });
        }, observerOptions);

        document
            .querySelectorAll(".stat-counter")
            .forEach((el) => observer.observe(el));
    };

    animateStats();
    document.addEventListener("astro:page-load", animateStats);
</script>
