---
import { getCollection } from "astro:content";
import Button from "./ui/Button.astro";
import Container from "./ui/Container.astro";
import { HelpCircle } from "lucide-astro";
import { SITE_CONFIG } from "../config/site";
import { replacePlaceholder } from "../utils/content";

interface FAQData {
    question: string;
    answer: string;
}

interface FAQItem {
    data: FAQData;
}

interface Props {
  faqs?: any[];
}

const { faqs: propFaqs } = Astro.props;

// FAQs to display after processing
let displayFaqs = [];

if (propFaqs && propFaqs.length > 0) {
  // Normalize prop data to match collection structure (access via .data or direct)
  displayFaqs = propFaqs.map((f: any) => ({
    data: {
      question: replacePlaceholder(f.question || f.data?.question),
      answer: replacePlaceholder(f.answer || f.data?.answer)
    }
  }));
} else {
  const globalFaqs = await getCollection("faqs");
  const sorted = [...globalFaqs].sort((a, b) => {
    const orderA = a.data.order ?? 99;
    const orderB = b.data.order ?? 99;
    return orderA - orderB;
  });
  displayFaqs = sorted.map(faq => ({
      data: {
          question: replacePlaceholder(faq.data.question),
          answer: replacePlaceholder(faq.data.answer)
      }
  }));
}
---

<section class="py-20 md:py-32 bg-light relative overflow-hidden">
    <!-- Decorative Background Elements -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-accent/5 blur-[120px] rounded-full"></div>
        <div class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-primary/5 blur-[120px] rounded-full"></div>
    </div>

    <Container class="relative z-10">
        <!-- Section Header -->
        <div class="text-center mb-16">
            <p
                class="text-primary font-bold text-lg tracking-[0.2em] mb-4 uppercase font-secondary"
            >
                Common Questions
            </p>
            <h2
                class="text-4xl md:text-6xl font-bold text-primary mb-6 font-display"
            >
                Frequently Asked <span class="text-primary">Questions</span>
            </h2>
            <p class="text-[var(--text-body)] text-lg font-medium">
                Get answers to the most common questions about our electrical
                services and availability.
            </p>
        </div>

        <!-- FAQ Accordion - Refined Angular Electric Design -->
        <div class="space-y-4" style="max-width: var(--container-content, 900px); margin: 0 auto;">
            {
                displayFaqs.slice(0, 6).map((faq, index) => (
                    <div class="faq-item group relative glass-bg glass-border transition-all duration-300 hover:shadow-2xl hover:border-accent/40 rounded-2xl overflow-hidden">
                        <!-- Subtle glow on hover -->
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-accent/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                        
                        <button
                            class="faq-question w-full text-left p-5 md:p-6 flex items-center gap-4 relative z-10"
                            data-index={index}
                            aria-expanded="false"
                        >
                            <span class="flex-1 font-bold text-primary group-hover:text-accent transition-colors duration-300 font-display uppercase tracking-tight" style="font-size: clamp(0.95rem, 1.25vw, 1.1rem);">
                                {faq.data.question}
                            </span>
                            
                            <!-- Lightning bolt plus icon -->
                            <div class="faq-icon flex-shrink-0 w-8 h-8 flex items-center justify-center bg-primary group-hover:bg-accent transition-all duration-300 relative rounded-lg">
                                <span class="text-white font-bold text-xl leading-none transition-transform duration-300">+</span>
                            </div>
                        </button>
                        
                        <div
                            class="faq-answer overflow-hidden transition-all duration-300 ease-in-out"
                            style="max-height: 0;"
                            data-index={index}
                        >
                            <div class="px-5 md:px-8 pb-5 md:pb-8 text-body leading-relaxed border-t border-accent/10 pt-4" style="font-size: clamp(0.9rem, 1.1vw, 1rem);">
                                {faq.data.answer}
                            </div>
                        </div>
                    </div>
                ))
            }
        </div>

        <!-- CTA Button -->
        <div class="text-center mt-16">
            <Button
                href="/faq"
                variant="primary"
                class="px-12 py-5 text-lg font-black flex items-center gap-2"
            >
                <HelpCircle class="w-5 h-5" />
                View All FAQs
            </Button>
        </div>
    </Container>
</section>

<script>
    // FAQ Accordion Logic
    const faqQuestions = document.querySelectorAll(".faq-question");

    faqQuestions.forEach((question) => {
        question.addEventListener("click", () => {
            const index = question.getAttribute("data-index");
            const answer = document.querySelector(
                `.faq-answer[data-index="${index}"]`,
            ) as HTMLElement;
            const icon = question.querySelector(".faq-icon") as HTMLElement;
            const isExpanded =
                question.getAttribute("aria-expanded") === "true";
            const parentItem = question.closest(".faq-item");

            // Close all other FAQs
            faqQuestions.forEach((q) => {
                const qIndex = q.getAttribute("data-index");
                if (qIndex !== index) {
                    const qAnswer = document.querySelector(
                        `.faq-answer[data-index="${qIndex}"]`,
                    ) as HTMLElement;
                    const qIcon = q.querySelector(".faq-icon") as HTMLElement;
                    const qParent = q.closest(".faq-item");

                    if (qAnswer) {
                        qAnswer.style.maxHeight = "0";
                    }
                    q.setAttribute("aria-expanded", "false");
                    if (qIcon) {
                        qIcon.style.transform = "rotate(0deg)";
                    }
                    qParent?.classList.remove("ring-2", "ring-accent/30");
                }
            });

            // Toggle current FAQ
            if (isExpanded) {
                // Close it
                if (answer) {
                    answer.style.maxHeight = "0";
                }
                question.setAttribute("aria-expanded", "false");
                if (icon) {
                    icon.style.transform = "rotate(0deg)";
                }
                parentItem?.classList.remove("ring-2", "ring-accent/30");
            } else {
                // Open it
                if (answer) {
                    answer.style.maxHeight = answer.scrollHeight + "px";
                }
                question.setAttribute("aria-expanded", "true");
                if (icon) {
                    icon.style.transform = "rotate(45deg)";
                }
                parentItem?.classList.add("ring-2", "ring-accent/30");
            }
        });
    });
</script>
