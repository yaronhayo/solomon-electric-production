---
import { Image } from "astro:assets";
import { IMAGES } from "../config/images";
const logoImage = IMAGES.branding.logoNew;
import CtaButton from "./ui/CtaButton.astro";
import Container from "./ui/Container.astro";
import {
    ChevronDown,
    Zap,
    MapPin,
    ArrowRight,
    Menu,
    X,
    Phone,
    Star,
    HelpCircle,
    Info,
    Mail,
    Calendar, // Added Calendar icon
} from "lucide-astro";
import { SITE_CONFIG } from "../config/site";
import PhoneNumber from "./ui/PhoneNumber.astro";

// Top services for mega menu
const topServices = [
    { name: "Panel Upgrades", slug: "electrical-panel-upgrade-100a-to-200a" },
    { name: "24/7 Emergency", slug: "24-7-emergency-electrical-service" },
    {
        name: "EV Charger Installation",
        slug: "level-2-ev-charger-installation",
    },
    { name: "Surge Protection", slug: "whole-home-surge-protection" },
    { name: "Recessed Lighting", slug: "recessed-lighting-installation" },
    {
        name: "Ceiling Fan Installation",
        slug: "ceiling-fan-light-fixture-installation",
    },
];

// Top service areas for mega menu
const topServiceAreas = [
    "Miami",
    "Fort Lauderdale",
    "Hollywood",
    "Pembroke Pines",
    "Miami Beach",
    "Coral Springs",
];
---

<header class="w-full font-secondary sticky top-0 z-[var(--z-sticky)]">
    <!-- Main Navbar -->
    <nav
        class="bg-white border-b border-gray-100 shadow-[var(--shadow-sm)]"
        aria-label="Main Navigation"
    >
        <Container class="py-2 lg:py-3">
            <!-- Desktop Header (lg and up) -->
            <div
                class="hidden lg:grid lg:grid-cols-[minmax(180px,220px)_1fr_minmax(400px,auto)] items-center gap-4 xl:gap-8"
            >
                <!-- Left: Logo -->
                <a
                    href="/"
                    class="block max-w-[220px] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-accent)] focus-visible:ring-offset-4 rounded-sm"
                >
                    <Image
                        src={logoImage.src}
                        alt={logoImage.alt}
                        class="w-full h-auto"
                        loading="eager"
                        fetchpriority="high"
                    />
                </a>

                <!-- Center: Desktop Menu with Mega Menus -->
                <div class="flex items-center gap-4 xl:gap-6 justify-center">
                    <!-- Services Mega Menu -->
                    <div class="mega-menu-container group">
                        <a
                            href="/services"
                            class="mega-menu-trigger text-primary hover:text-accent transition-colors font-bold text-[length:var(--text-nav)] tracking-wider uppercase whitespace-nowrap flex items-center gap-1 group/trigger focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-4 rounded-sm"
                            aria-haspopup="true"
                            aria-expanded="false"
                        >
                            <span class="shimmer-authority">Services</span>
                            <ChevronDown
                                class="w-3 h-3 transition-transform group-hover/trigger:rotate-180"
                            />
                        </a>
                        <section
                            class="mega-menu"
                            aria-labelledby="mega-menu-services-label"
                        >
                            <div class="mega-menu-content">
                                <div class="mega-menu-header">
                                    <span
                                        class="mega-menu-label inline-flex items-center gap-1.5"
                                        id="mega-menu-services-label"
                                        ><Zap class="w-3.5 h-3.5" /> Popular Services</span
                                    >
                                </div>
                                <div class="mega-menu-grid">
                                    {
                                        topServices.map((service) => (
                                            <a
                                                href={`/services/${service.slug}`}
                                                class="mega-menu-item"
                                            >
                                                <Zap class="mega-menu-icon" />
                                                <span>{service.name}</span>
                                            </a>
                                        ))
                                    }
                                </div>
                                <a href="/services" class="mega-menu-view-all">
                                    View All Services
                                    <ArrowRight class="w-4 h-4" />
                                </a>
                            </div>
                        </section>
                    </div>

                    <!-- Service Areas Mega Menu -->
                    <div class="mega-menu-container group">
                        <a
                            href="/service-areas"
                            class="mega-menu-trigger text-primary hover:text-accent transition-colors font-bold text-[length:var(--text-nav)] tracking-wider uppercase whitespace-nowrap flex items-center gap-1 group/trigger focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-4 rounded-sm"
                            aria-haspopup="true"
                            aria-expanded="false"
                        >
                            <span class="shimmer-authority">Service Areas</span>
                            <ChevronDown
                                class="w-3 h-3 transition-transform group-hover/trigger:rotate-180"
                            />
                        </a>
                        <section
                            class="mega-menu"
                            aria-labelledby="mega-menu-cities-label"
                        >
                            <div class="mega-menu-content">
                                <div class="mega-menu-header">
                                    <span
                                        class="mega-menu-label inline-flex items-center gap-1.5"
                                        id="mega-menu-cities-label"
                                        ><MapPin class="w-3.5 h-3.5" /> Top Cities
                                        We Serve</span
                                    >
                                </div>
                                <div class="mega-menu-grid">
                                    {
                                        topServiceAreas.map((area) => (
                                            <a
                                                href={`/service-areas/${area.toLowerCase().replace(/\s+/g, "-")}`}
                                                class="mega-menu-item"
                                            >
                                                <MapPin class="mega-menu-icon" />
                                                <span>{area}</span>
                                            </a>
                                        ))
                                    }
                                </div>
                                <a
                                    href="/service-areas"
                                    class="mega-menu-view-all"
                                >
                                    View All Service Areas
                                    <ArrowRight class="w-4 h-4" />
                                </a>
                            </div>
                        </section>
                    </div>

                    <a
                        href="/faq"
                        class="text-primary hover:text-accent transition-colors font-bold text-[length:var(--text-nav)] tracking-wider uppercase whitespace-nowrap"
                        >FAQ</a
                    >
                    <a
                        href="/reviews"
                        class="text-primary hover:text-accent transition-colors font-bold text-[length:var(--text-nav)] tracking-wider uppercase whitespace-nowrap"
                        >Reviews</a
                    >
                    <a
                        href="/about"
                        class="text-primary hover:text-accent transition-colors font-bold text-[length:var(--text-nav)] tracking-wider uppercase whitespace-nowrap"
                        >About</a
                    >
                    <a
                        href="/contact"
                        class="text-primary hover:text-accent transition-colors font-bold text-[length:var(--text-nav)] tracking-wider uppercase whitespace-nowrap"
                        >Contact</a
                    >
                </div>

                <!-- Right: CTAs -->
                <div class="flex items-center gap-3 xl:gap-4 justify-end">
                    <CtaButton
                        action="book"
                        text="Book Online"
                        size="md"
                        class="whitespace-nowrap"
                    />
                    <CtaButton
                        action="call"
                        variant="secondary"
                        size="md"
                        class="whitespace-nowrap"
                    />
                </div>
            </div>

            <!-- Mobile & Tablet Header (below lg) -->
            <div class="flex lg:hidden items-center justify-between">
                <a href="/" class="block w-32 md:w-40 flex-shrink-0">
                    <Image
                        src={logoImage.src}
                        alt={logoImage.alt}
                        class="w-full h-auto"
                        loading="eager"
                    />
                </a>
                <button
                    type="button"
                    id="mobile-menu-btn"
                    class="text-primary p-2"
                    aria-label="Open Menu"
                    aria-expanded="false"
                    aria-controls="mobile-menu"
                >
                    <Menu class="w-8 h-8" aria-hidden="true" />
                </button>
            </div>
        </Container>
    </nav>
</header>

<!-- Mobile Menu Overlay (for phones and tablets) -->
<div
    id="mobile-menu"
    class="fixed inset-y-0 right-0 w-full max-w-[400px] bg-gradient-to-br from-primary via-[var(--color-primary-dark)] to-[var(--color-primary-dark)] z-[var(--z-modal)] transform translate-x-full transition-all duration-300 ease-out lg:hidden flex flex-col shadow-[var(--shadow-xl)] overflow-y-auto backdrop-blur-sm"
    role="dialog"
    aria-modal="true"
    aria-label="Mobile Navigation"
>
    <!-- Glass Overlay Effect -->
    <div class="absolute inset-0 bg-white/5 backdrop-blur-md"></div>

    <!-- Header -->
    <div
        class="relative flex items-center justify-between p-8 bg-white border-b border-gray-200"
    >
        <a href="/" class="transition-transform hover:scale-105">
            <Image
                src={logoImage.src}
                alt={logoImage.alt}
                class="h-[60px] w-auto object-contain"
                loading="eager"
            />
        </a>
        <button
            type="button"
            id="close-menu-btn"
            class="w-10 h-10 bg-primary/10 hover:bg-primary/20 flex items-center justify-center rounded-[var(--radius-lg)] transition-all duration-200 hover:rotate-90 group"
            aria-label="Close Menu"
        >
            <X
                class="w-5 h-5 text-primary group-hover:text-accent transition-colors"
            />
        </button>
    </div>

    <!-- Content -->
    <div class="relative flex flex-col gap-12 px-8 py-6 flex-grow">
        <!-- Navigation Links -->
        <nav
            class="flex flex-col gap-6 animate-fade-in-up"
            aria-label="Mobile Navigation"
        >
            <a
                href="/services"
                class="group flex items-center gap-3 font-secondary text-[length:var(--text-h5)] font-bold text-white hover:text-accent transition-all duration-200 hover:translate-x-2 py-2"
            >
                <Zap
                    class="w-5 h-5 text-accent group-hover:scale-110 transition-transform"
                />
                <span>Services</span>
                <ArrowRight
                    class="w-4 h-4 ml-auto opacity-0 group-hover:opacity-100 transition-opacity"
                />
            </a>
            <a
                href="/service-areas"
                class="group flex items-center gap-3 font-secondary text-[length:var(--text-h5)] font-bold text-white hover:text-accent transition-all duration-200 hover:translate-x-2 py-2"
            >
                <MapPin
                    class="w-5 h-5 text-accent group-hover:scale-110 transition-transform"
                />
                <span>Service Areas</span>
                <ArrowRight
                    class="w-4 h-4 ml-auto opacity-0 group-hover:opacity-100 transition-opacity"
                />
            </a>
            <a
                href="/faq"
                class="group flex items-center gap-3 font-secondary text-[length:var(--text-h5)] font-bold text-white hover:text-accent transition-all duration-200 hover:translate-x-2 py-2"
            >
                <span
                    class="text-accent text-[length:var(--text-body)] inline-flex"
                    ><HelpCircle class="w-5 h-5" /></span
                >
                <span>FAQ</span>
                <ArrowRight
                    class="w-4 h-4 ml-auto opacity-0 group-hover:opacity-100 transition-opacity"
                />
            </a>
            <a
                href="/reviews"
                class="group flex items-center gap-3 font-secondary text-[length:var(--text-h5)] font-bold text-white hover:text-accent transition-all duration-200 hover:translate-x-2 py-2"
            >
                <span
                    class="text-accent text-[length:var(--text-body)] inline-flex"
                    ><Star class="w-5 h-5" /></span
                >
                <span>Reviews</span>
                <ArrowRight
                    class="w-4 h-4 ml-auto opacity-0 group-hover:opacity-100 transition-opacity"
                />
            </a>
            <a
                href="/about"
                class="group flex items-center gap-3 font-secondary text-[length:var(--text-h5)] font-bold text-white hover:text-accent transition-all duration-200 hover:translate-x-2 py-2"
            >
                <span
                    class="text-accent text-[length:var(--text-body)] inline-flex"
                    ><Info class="w-5 h-5" /></span
                >
                <span>About</span>
                <ArrowRight
                    class="w-4 h-4 ml-auto opacity-0 group-hover:opacity-100 transition-opacity"
                />
            </a>
            <a
                href="/contact"
                class="group flex items-center gap-3 font-secondary text-[length:var(--text-h5)] font-bold text-white hover:text-accent transition-all duration-200 hover:translate-x-2 py-2"
            >
                <span
                    class="text-accent text-[length:var(--text-body)] inline-flex"
                    ><Mail class="w-5 h-5" /></span
                >
                <span>Contact</span>
                <ArrowRight
                    class="w-4 h-4 ml-auto opacity-0 group-hover:opacity-100 transition-opacity"
                />
            </a>
        </nav>

        <!-- CTAs -->
        <div
            class="flex flex-col gap-4 mt-auto animate-fade-in-up"
            style="animation-delay: 0.1s;"
        >
            <!-- Divider -->
            <div
                class="h-px bg-gradient-to-r from-transparent via-white/20 to-transparent my-2"
            >
            </div>

            <!-- All Services Button -->
            <a
                href="/services"
                class="group relative flex items-center justify-center gap-3 px-6 py-4 bg-accent hover:bg-accent/90 rounded-[var(--radius-lg)] transition-all duration-300 hover:shadow-[var(--shadow-lg)] hover:shadow-accent/20 hover:scale-[1.02] overflow-hidden"
            >
                <div
                    class="absolute inset-0 bg-gradient-to-r from-accent/0 via-white/10 to-accent/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"
                >
                </div>
                <Zap class="w-5 h-5 text-primary relative z-10" />
                <span
                    class="font-secondary text-[length:var(--text-body)] font-bold text-primary relative z-10"
                    >All Services</span
                >
                <ArrowRight
                    class="w-5 h-5 text-primary relative z-10 transition-transform group-hover:translate-x-1"
                />
            </a>

            <!-- Call&nbsp;Now Button -->
            <a
                href={SITE_CONFIG.contact.phone.href}
                class="group relative flex items-center justify-center gap-3 px-6 py-4 bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 rounded-[var(--radius-lg)] transition-all duration-300 hover:shadow-[var(--shadow-lg)] hover:shadow-white/10 hover:scale-[1.02] overflow-hidden"
            >
                <div
                    class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/10 to-white/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"
                >
                </div>
                <span
                    class="w-9 h-9 bg-accent rounded-[var(--radius-lg)] flex items-center justify-center relative z-10 group-hover:scale-110 transition-transform"
                >
                    <Phone class="w-5 h-5 text-primary" />
                </span>
                <span
                    class="font-secondary text-[length:var(--text-body)] font-bold text-white relative z-10"
                    >Call&nbsp;Now</span
                ></a
            >

            <!-- Contact Info -->
            <div class="text-center mt-4 space-y-2">
                <p
                    class="text-white/60 text-[length:var(--text-caption)] uppercase tracking-wider font-secondary"
                >
                    Available 24/7
                </p>
                <p
                    class="text-accent text-[length:var(--text-h5)] font-bold font-secondary"
                >
                    <PhoneNumber />
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    /* =========================================
       MEGA MENU STYLES
       ========================================= */
    .mega-menu-container {
        position: relative;
    }

    .mega-menu-trigger {
        position: relative;
        z-index: var(--z-header);
    }

    .mega-menu-trigger:focus-visible {
        outline: var(--outline-accent);
        outline-offset: 4px;
        border-radius: var(--radius-sm);
    }

    .mega-menu {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(8px);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: all var(--transition-fast);
        padding-top: 12px; /* Gap between trigger and menu */
    }

    .mega-menu-container:hover .mega-menu,
    .mega-menu-container:focus-within .mega-menu {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        transform: translateX(-50%) translateY(0);
    }

    .mega-menu-content {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        min-width: 280px;
        overflow: hidden;
        backdrop-filter: blur(var(--glass-blur));
        -webkit-backdrop-filter: blur(var(--glass-blur));
    }

    .mega-menu-header {
        padding: 0.75rem 1rem;
        background: linear-gradient(
            135deg,
            var(--color-primary) 0%,
            var(--color-primary-dark) 100%
        );
        border-bottom: 2px solid var(--color-accent);
    }

    .mega-menu-label {
        font-size: var(--text-caption);
        font-weight: 700;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .mega-menu-grid {
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
    }

    .mega-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem 0.75rem;
        color: var(--text-body);
        font-size: var(--text-nav);
        font-weight: 500;
        text-decoration: none;
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
    }

    .mega-menu-item:hover {
        background: rgba(var(--color-accent-rgb), 0.08);
        color: var(--color-primary);
    }

    .mega-menu-item:hover .mega-menu-icon {
        color: var(--color-accent);
    }

    .mega-menu-icon {
        width: 1rem;
        height: 1rem;
        color: var(--color-primary);
        flex-shrink: 0;
        transition: color var(--transition-fast);
    }

    .mega-menu-view-all {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: var(--bg-surface);
        color: var(--color-primary);
        font-size: var(--text-label);
        font-weight: 700;
        text-transform: uppercase;
        text-decoration: none;
        letter-spacing: 0.05em;
        border-top: 1px solid var(--border-light);
        transition: all var(--transition-fast);
    }

    .mega-menu-view-all:hover {
        background: var(--color-accent);
        color: var(--color-primary);
    }

    .mega-menu-view-all svg {
        width: 1rem;
        height: 1rem;
    }

    /* =========================================
       MOBILE MENU ANIMATIONS
       ========================================= */
    .animate-fade-in-up {
        animation: fadeInUp var(--transition-base) forwards;
    }

    /* Mobile menu backdrop */
    #mobile-menu-backdrop {
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }
</style>

<script>
    const menuBtn = document.getElementById("mobile-menu-btn");
    const closeBtn = document.getElementById("close-menu-btn");
    const menu = document.getElementById("mobile-menu");

    // Create backdrop
    const backdrop = document.createElement("div");
    backdrop.id = "mobile-menu-backdrop";
    backdrop.className =
        "fixed inset-0 bg-black/50 z-[calc(var(--z-modal)-1)] opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden";
    document.body.appendChild(backdrop);

    function toggleMenu() {
        const isOpen = !menu?.classList.contains("translate-x-full");

        menu?.classList.toggle("translate-x-full");
        document.body.classList.toggle("overflow-hidden");

        // Toggle backdrop
        if (!isOpen) {
            if (menuBtn) {
                menuBtn.setAttribute("aria-expanded", "true");
            }
            backdrop.classList.remove("pointer-events-none");
            backdrop.classList.remove("opacity-0");
        } else {
            if (menuBtn) {
                menuBtn.setAttribute("aria-expanded", "false");
            }
            backdrop.classList.add("opacity-0");

            setTimeout(() => {
                backdrop.classList.add("pointer-events-none");
            }, 300);
        }
    }

    menuBtn?.addEventListener("click", toggleMenu);
    closeBtn?.addEventListener("click", toggleMenu);
    backdrop?.addEventListener("click", toggleMenu);

    menu?.querySelectorAll("a").forEach((link) => {
        link.addEventListener("click", toggleMenu);
    });

    // Escape key closes menu
    document.addEventListener("keydown", (e) => {
        if (
            e.key === "Escape" &&
            !menu?.classList.contains("translate-x-full")
        ) {
            toggleMenu();
            menuBtn?.focus();
        }
    });

    // Focus trap inside mobile menu
    document.addEventListener("keydown", (e) => {
        if (
            e.key !== "Tab" ||
            !menu ||
            menu.classList.contains("translate-x-full")
        )
            return;

        const focusable = menu.querySelectorAll<HTMLElement>(
            'a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])',
        );
        if (focusable.length === 0) return;

        const first = focusable[0];
        const last = focusable[focusable.length - 1];

        if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
        }
    });
</script>
