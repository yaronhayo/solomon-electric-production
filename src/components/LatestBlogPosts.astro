---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import Button from "./ui/Button.astro";
import Container from "./ui/Container.astro";

// Get the 3 most recent blog posts
const allPosts = await getCollection("blog");
const latestPosts = allPosts
    .sort(
        (a, b) =>
            new Date(b.data.pubDate).getTime() -
            new Date(a.data.pubDate).getTime(),
    )
    .slice(0, 3);

// Calculate reading time
function calculateReadingTime(content: string): number {
    const wordsPerMinute = 200;
    const words = content.trim().split(/\s+/).length;
    return Math.ceil(words / wordsPerMinute);
}
---

<section class="py-20 md:py-32 bg-light">
    <Container>
        <!-- Section Header -->
        <div class="text-center mb-16">
            <h4
                class="text-accent font-bold text-lg tracking-[0.2em] mb-4 uppercase font-display"
            >
                From The Blog
            </h4>
            <h2
                class="text-4xl md:text-6xl font-black text-primary mb-6 uppercase"
            >
                Latest <span class="text-accent">Insights & Tips</span>
            </h2>
            <p class="text-gray-600 text-lg font-medium">
                Stay informed with expert electrical advice, safety tips, and
                industry updates from our team of licensed electricians.
            </p>
        </div>

        <!-- Blog Posts Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {
                latestPosts.map((post) => {
                    const readingTime = calculateReadingTime(post.body);

                    return (
                        <a
                            href={`/blog/${post.slug}`}
                            class="group bg-white border border-gray-100 rounded-2xl overflow-hidden hover:border-accent hover:shadow-lg hover:transform hover:-translate-y-2 transition-all duration-300 flex flex-col shadow-sm"
                        >
                            {/* Featured Image */}
                            <div class="relative h-64 overflow-hidden bg-gray-100">
                                {post.data.image ? (
                                    <Image
                                        src={post.data.image}
                                        alt={post.data.title}
                                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                                        widths={[400, 800]}
                                        sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 33vw"
                                    />
                                ) : (
                                    <div class="w-full h-full flex items-center justify-center">
                                        <svg
                                            class="w-16 h-16 text-gray-300"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"
                                            />
                                        </svg>
                                    </div>
                                )}
                                {/* Reading Time Badge */}
                                <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-primary shadow-sm border border-gray-100">
                                    {readingTime} min read
                                </div>
                            </div>

                            {/* Content */}
                            <div class="p-6 md:p-8 flex flex-col flex-grow">
                                {/* Date */}
                                <time class="text-accent text-sm font-bold mb-3 block uppercase tracking-wide">
                                    {new Date(
                                        post.data.pubDate,
                                    ).toLocaleDateString("en-US", {
                                        month: "long",
                                        day: "numeric",
                                        year: "numeric",
                                    })}
                                </time>

                                {/* Title */}
                                <h3 class="text-xl md:text-2xl font-black text-primary mb-4 group-hover:text-accent transition-colors line-clamp-2 leading-tight uppercase font-display">
                                    {post.data.title}
                                </h3>

                                {/* Excerpt */}
                                <p class="text-gray-600 leading-relaxed line-clamp-3 mb-6 flex-grow font-medium">
                                    {post.data.description}
                                </p>

                                {/* Read More Link */}
                                <span class="inline-flex items-center text-accent font-bold uppercase tracking-widest text-sm group-hover:gap-3 transition-all duration-300">
                                    Read Article{" "}
                                    <span class="ml-2 group-hover:translate-x-1 transition-transform duration-300">
                                        â†’
                                    </span>
                                </span>
                            </div>
                        </a>
                    );
                })
            }
        </div>

        <!-- CTA Button -->
        <div class="text-center mt-16">
            <Button
                href="/blog"
                variant="primary"
                class="px-12 py-5 text-lg font-black">View All Articles</Button
            >
        </div>
    </Container>
</section>
