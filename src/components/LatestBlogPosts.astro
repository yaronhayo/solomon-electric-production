---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import Button from "./ui/Button.astro";
import Container from "./ui/Container.astro";
import { ArrowRight } from "lucide-astro";

// Get the 3 most recent blog posts
const allPosts = await getCollection("blog");
const latestPosts = allPosts
    .sort(
        (a, b) =>
            new Date(b.data.pubDate).getTime() -
            new Date(a.data.pubDate).getTime(),
    )
    .slice(0, 3);

// Calculate reading time
function calculateReadingTime(content: string): number {
    const wordsPerMinute = 200;
    const words = content.trim().split(/\s+/).length;
    return Math.ceil(words / wordsPerMinute);
}
---

<section class="py-20 md:py-32 bg-light">
    <Container>
        <!-- Section Header -->
        <div class="text-center mb-16">
            <p
                class="text-accent font-bold text-lg tracking-[0.2em] mb-4 uppercase font-secondary"
            >
                Expert Electrical Knowledge
            </p>
            <h2
                class="text-4xl md:text-6xl font-black text-primary mb-6 uppercase"
            >
                Helpful <span class="text-accent">Guides & Tips</span>
            </h2>
            <p class="text-[var(--text-body)] text-lg font-medium">
                Get expert electrical advice from licensed Miami electricians.
                Learn about home safety, energy efficiency, and when to call a
                professional.
            </p>
        </div>

        <!-- Blog Posts Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {
                latestPosts.map((post) => {
                    const readingTime = calculateReadingTime(post.body);

                    return (
                        <article class="h-full">
                            <a
                                href={`/blog/${post.slug}`}
                                class="group bg-[var(--bg-surface)] border border-[var(--border-light)] rounded-[var(--radius-xl)] overflow-hidden hover:border-[var(--border-focus)] hover:shadow-[var(--shadow-brand)] hover:transform hover:-translate-y-2 transition-all duration-[var(--transition-base)] flex flex-col h-full shadow-[var(--shadow-sm)]"
                            >
                                <div
                                    class="relative overflow-hidden bg-[var(--bg-surface-hover)]"
                                    style="aspect-ratio: 16/9;"
                                >
                                    {post.data.image ? (
                                        <Image
                                            src={post.data.image}
                                            alt={post.data.title}
                                            width={600}
                                            height={338}
                                            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-[var(--transition-slow)]"
                                            loading="lazy"
                                        />
                                    ) : (
                                        <div class="w-full h-full flex items-center justify-center">
                                            <svg
                                                class="w-16 h-16 text-gray-300"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M13 10V3L4 14h7v7l9-11h-7z"
                                                />
                                            </svg>
                                        </div>
                                    )}
                                    {/* Reading Time Badge */}
                                    <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-primary shadow-sm border border-gray-100">
                                        {readingTime} min read
                                    </div>
                                </div>

                                {/* Content */}
                                <div class="p-6 md:p-8 flex flex-col flex-grow">
                                    {/* Date */}
                                    <time class="text-accent text-sm font-bold mb-3 block uppercase tracking-wide">
                                        {new Date(
                                            post.data.pubDate,
                                        ).toLocaleDateString("en-US", {
                                            month: "long",
                                            day: "numeric",
                                            year: "numeric",
                                            timeZone: "America/New_York",
                                        })}
                                    </time>

                                    {/* Title */}
                                    <h3 class="text-xl md:text-2xl font-bold text-primary mb-3 tracking-tight group-hover:text-accent transition-colors duration-[var(--transition-base)] line-clamp-2 uppercase font-secondary">
                                        {post.data.title}
                                    </h3>

                                    {/* Excerpt */}
                                    <p class="text-[var(--text-body)] leading-relaxed line-clamp-3 mb-6 flex-grow font-medium">
                                        {post.data.description}
                                    </p>

                                    {/* Read More Link */}
                                    <span class="inline-flex items-center text-accent-text font-bold uppercase tracking-widest text-sm group-hover:gap-3 transition-all duration-[var(--transition-base)]">
                                        Read Article{" "}
                                        <ArrowRight class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform duration-[var(--transition-base)]" />
                                    </span>
                                </div>
                            </a>
                        </article>
                    );
                })
            }
        </div>

        <!-- CTA Button -->
        <div class="text-center mt-16">
            <Button
                href="/blog"
                variant="primary"
                class="px-12 py-5 text-lg font-black flex items-center gap-2"
            >
                View All Articles
                <ArrowRight class="w-5 h-5" />
            </Button>
        </div>
    </Container>
</section>
