---
import { SITE_CONFIG } from "../config/site";
import Button from "./ui/Button.astro";
import { MapPin, User, Clipboard, ArrowRight, ChevronLeft } from "lucide-astro";

interface Props {
    idPrefix?: string;
}

const { idPrefix = "booking" } = Astro.props;
const getPrefixedId = (id: string) => `${idPrefix}-${id}`;
---

<div
    class="booking-form-container w-full min-w-0 bg-white/95 backdrop-blur-sm shadow-[0_20px_60px_rgba(var(--color-accent-rgb),0.15)] overflow-hidden relative z-20 border-l-4 border-l-[var(--color-accent)] rounded-[var(--radius-sm)] max-w-[500px] mx-auto lg:mx-0"
    data-id-prefix={idPrefix}
    data-gmaps-key={SITE_CONFIG.seo.integrations.googleMaps}
    data-recaptcha-key={SITE_CONFIG.seo.integrations.recaptcha}
>
    <!-- Animated Background Pattern -->
    <div class="absolute inset-0 opacity-5 pointer-events-none">
        <div
            class="absolute top-0 right-0 w-64 h-64 bg-[var(--color-accent)] rounded-[var(--radius-full)] filter blur-3xl animate-pulse"
        >
        </div>
        <div
            class="absolute bottom-0 left-0 w-48 h-48 bg-[var(--color-primary)] rounded-[var(--radius-full)] filter blur-3xl animate-pulse"
            style="animation-delay: 1s;"
        >
        </div>
    </div>

    <!-- Decorative Corner Elements -->
    <div
        class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-accent/20 via-accent/10 to-transparent pointer-events-none"
    >
    </div>
    <div
        class="absolute bottom-0 left-0 w-32 h-32 bg-gradient-to-tr from-primary/10 to-transparent pointer-events-none"
    >
    </div>

    <!-- Enhanced Header -->
    <div
        class="header-gradient p-[var(--spacing-lg)] text-center relative overflow-hidden"
    >
        <!-- Animated Accent Strip -->
        <div
            class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-accent to-transparent glow-pulse"
        >
        </div>

        <h2
            class="text-white text-[length:var(--text-h5)] md:text-[length:var(--text-h4)] font-black uppercase tracking-wider font-display mb-2"
        >
            Request Service
        </h2>
        <p
            class="text-accent text-[length:var(--text-label)] font-bold uppercase tracking-widest font-display flex items-center justify-center gap-2"
        >
            <svg
                class="w-4 h-4 animate-pulse"
                fill="currentColor"
                viewBox="0 0 20 20"
                aria-hidden="true"
            >
                <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                    clip-rule="evenodd"></path>
            </svg>
            Fast Response Guaranteed
        </p>

        <!-- Step Progress Indicator -->
        <div
            class="mt-6 flex items-center justify-center gap-2"
            id={getPrefixedId("progressIndicator")}
        >
            <div class="step-indicator active" data-step="1">
                <div class="step-icon">
                    <Clipboard class="w-4 h-4" />
                </div>
                <span class="step-label">Service</span>
            </div>
            <div class="step-line"></div>
            <div class="step-indicator" data-step="2">
                <div class="step-icon">
                    <MapPin class="w-4 h-4" />
                </div>
                <span class="step-label">Location</span>
            </div>
            <div class="step-line"></div>
            <div class="step-indicator" data-step="3">
                <div class="step-icon">
                    <User class="w-4 h-4" />
                </div>
                <span class="step-label">Contact</span>
            </div>
        </div>
    </div>

    <form
        id={getPrefixedId("bookingForm")}
        class="p-[var(--spacing-md)] md:p-[var(--spacing-xl)] relative min-h-[380px] flex flex-col"
    >
        <!-- Honeypot anti-spam field â€” hidden from humans, bots will fill it -->
        <div
            style="position:absolute;left:-9999px;top:-9999px;opacity:0;height:0;width:0;overflow:hidden;"
            aria-hidden="true"
        >
            <label for={getPrefixedId("website")}>Website</label>
            <input
                type="text"
                id={getPrefixedId("website")}
                name="website"
                tabindex="-1"
                autocomplete="off"
            />
        </div>

        <!-- Step 1: Service Details -->
        <div class="form-step active flex-grow" data-step="1">
            <div class="mb-6">
                <label
                    for={getPrefixedId("serviceType")}
                    class="block text-primary font-bold uppercase text-[length:var(--text-caption)] mb-2 tracking-wide font-secondary"
                >
                    Service Needed
                </label>
                <select
                    id={getPrefixedId("serviceType")}
                    name="serviceType"
                    required
                    class="w-full bg-[var(--bg-surface-hover)] border-2 border-[var(--border-glass)] rounded-[var(--radius-sm)] px-4 py-3 text-[var(--clr-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all cursor-pointer appearance-none font-body"
                >
                    <option value="" disabled selected
                        >Select a service...</option
                    >
                    <option value="electrical_repair">Electrical Repair</option>
                    <option value="panel_upgrade">Panel Upgrade</option>
                    <option value="lighting_installation"
                        >Lighting Installation</option
                    >
                    <option value="outlet_switch">Outlet / Switch Issue</option>
                    <option value="ev_charger">EV Charger Installation</option>
                    <option value="generator">Generator Service</option>
                    <option value="inspection">Safety Inspection</option>
                    <option value="other">Other</option>
                </select>
                <div
                    class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none mt-8 mr-6"
                >
                    <svg
                        class="w-4 h-4 text-[var(--clr-muted)]"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 9l-7 7-7-7"></path></svg
                    >
                </div>
            </div>

            <div id={getPrefixedId("additionalDetailsContainer")} class="mb-6">
                <label
                    for={getPrefixedId("serviceDetails")}
                    class="block text-primary font-bold uppercase text-[length:var(--text-caption)] mb-2 tracking-wide font-display"
                >
                    Additional Details <span
                        class="text-gray-400 normal-case font-normal"
                        >(Optional)</span
                    >
                </label>
                <textarea
                    id={getPrefixedId("serviceDetails")}
                    name="serviceDetails"
                    rows="4"
                    class="w-full bg-[var(--bg-surface-hover)] border-2 border-[var(--border-glass)] rounded-[var(--radius-sm)] px-4 py-3 text-[var(--clr-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-[var(--ring-accent)] transition-all resize-none font-body"
                    placeholder="Describe your issue or project..."></textarea>
            </div>

            <div class="mt-auto pt-8 flex justify-center">
                <Button
                    type="button"
                    variant="primary"
                    size="lg"
                    class="next-step-btn flex gap-2"
                >
                    Continue
                    <ArrowRight
                        class="w-5 h-5 group-hover:translate-x-1 transition-transform"
                    />
                </Button>
            </div>
        </div>

        <!-- Step 2: Location & Urgency -->
        <div class="form-step hidden flex-grow" data-step="2">
            <button
                type="button"
                class="prev-step-btn text-gray-400 hover:text-primary mb-4 flex items-center gap-1 text-[length:var(--text-label)] font-bold uppercase tracking-wide transition-colors font-display"
            >
                <ChevronLeft class="w-4 h-4" />
                Back
            </button>

            <div class="mb-4">
                <label
                    for={getPrefixedId("address")}
                    class="block text-primary font-bold uppercase text-[length:var(--text-caption)] mb-2 tracking-wide font-display"
                >
                    Service Address
                </label>
                <input
                    type="text"
                    id={getPrefixedId("address")}
                    name="address"
                    required
                    autocomplete="address-line1"
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--clr-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-[var(--ring-accent)] transition-all font-body"
                    placeholder="Start typing your address..."
                />
                <!-- Hidden fields for CRM address components -->
                <input
                    type="hidden"
                    id={getPrefixedId("streetNumber")}
                    name="streetNumber"
                />
                <input
                    type="hidden"
                    id={getPrefixedId("streetName")}
                    name="streetName"
                />
                <input type="hidden" id={getPrefixedId("city")} name="city" />
                <input type="hidden" id={getPrefixedId("state")} name="state" />
                <input
                    type="hidden"
                    id={getPrefixedId("zipCode")}
                    name="zipCode"
                />
            </div>

            <div
                id={getPrefixedId("addressFieldsContainer")}
                class="grid grid-cols-2 gap-4 mb-6 hidden"
            >
                <div>
                    <label
                        for={getPrefixedId("aptUnit")}
                        class="block text-primary font-bold uppercase text-[length:var(--text-caption)] mb-2 tracking-wide font-display"
                    >
                        Apt/Suite # <span
                            class="text-gray-400 normal-case font-normal"
                            >(Opt)</span
                        >
                    </label>
                    <input
                        type="text"
                        id={getPrefixedId("aptUnit")}
                        name="aptUnit"
                        class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--clr-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-[var(--ring-accent)] transition-all font-body"
                    />
                </div>
                <div>
                    <label
                        for={getPrefixedId("gateCode")}
                        class="block text-primary font-bold uppercase text-[length:var(--text-caption)] mb-2 tracking-wide font-display"
                    >
                        Gate Code <span
                            class="text-gray-400 normal-case font-normal"
                            >(Opt)</span
                        >
                    </label>
                    <input
                        type="text"
                        id={getPrefixedId("gateCode")}
                        name="gateCode"
                        class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--clr-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-[var(--ring-accent)] transition-all font-body"
                    />
                </div>
            </div>

            <div class="mb-6">
                <label
                    for={getPrefixedId("urgency")}
                    class="block text-primary font-bold uppercase text-[length:var(--text-caption)] mb-2 tracking-wide font-display"
                >
                    When do you need us?
                </label>
                <select
                    id={getPrefixedId("urgency")}
                    name="urgency"
                    required
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--clr-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-[var(--ring-accent)] transition-all cursor-pointer appearance-none font-body"
                >
                    <option value="" disabled selected>Select timing...</option>
                    <option value="ASAP">ASAP / Emergency</option>
                    <option value="Today">Today if possible</option>
                    <option value="FewDays">Next few days</option>
                    <option value="Planning">Just planning / Not sure</option>
                </select>
                <div
                    class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none mt-8 mr-6"
                >
                    <svg
                        class="w-4 h-4 text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        aria-hidden="true"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 9l-7 7-7-7"></path></svg
                    >
                </div>
            </div>

            <div class="mt-auto pt-8 flex justify-center">
                <Button
                    type="button"
                    variant="primary"
                    size="lg"
                    class="next-step-btn flex gap-2"
                >
                    Continue
                    <svg
                        class="w-5 h-5 group-hover:translate-x-1 transition-transform"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                    </svg>
                </Button>
            </div>
        </div>

        <!-- Step 3: Contact Info -->
        <div class="form-step hidden flex-grow" data-step="3">
            <button
                type="button"
                class="prev-step-btn text-gray-400 hover:text-primary mb-4 flex items-center gap-1 text-[length:var(--text-label)] font-bold uppercase tracking-wide transition-colors font-display"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path></svg
                >
                Back
            </button>

            <div class="mb-4">
                <label
                    for={getPrefixedId("name")}
                    class="block text-primary font-bold uppercase text-[length:var(--text-caption)] mb-2 tracking-wide font-display"
                >
                    Full Name
                </label>
                <input
                    type="text"
                    id={getPrefixedId("name")}
                    name="name"
                    required
                    autocomplete="name"
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--clr-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-[var(--ring-accent)] transition-all font-body"
                    placeholder="John Doe"
                />
            </div>

            <div class="mb-4">
                <label
                    for={getPrefixedId("phone")}
                    class="block text-primary font-bold uppercase text-[length:var(--text-caption)] mb-2 tracking-wide font-display"
                >
                    Phone Number
                </label>
                <input
                    type="tel"
                    id={getPrefixedId("phone")}
                    name="phone"
                    required
                    autocomplete="tel"
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--clr-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-[var(--ring-accent)] transition-all font-body"
                    placeholder="(305) 555-0123"
                />
            </div>

            <div class="mb-6">
                <label
                    for={getPrefixedId("email")}
                    class="block text-primary font-bold uppercase text-[length:var(--text-caption)] mb-2 tracking-wide font-display"
                >
                    Email Address <span
                        class="text-gray-400 normal-case font-normal"
                        >(Opt)</span
                    >
                </label>
                <input
                    type="email"
                    id={getPrefixedId("email")}
                    name="email"
                    autocomplete="email"
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--clr-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-[var(--ring-accent)] transition-all font-body"
                    placeholder="john@example.com"
                />
            </div>

            <div class="space-y-4 mb-6">
                <!-- SMS Consent Checkbox (TCR Compliance Required) -->
                <div class="flex items-start gap-2">
                    <input
                        type="checkbox"
                        id={getPrefixedId("smsConsent")}
                        name="smsConsent"
                        required
                        class="mt-1 w-4 h-4 text-accent border-gray-300 rounded focus:ring-[var(--color-accent)] focus:ring-offset-2 cursor-pointer"
                    />
                    <label
                        for={getPrefixedId("smsConsent")}
                        class="text-[length:var(--text-caption)] text-[var(--clr-body)] font-medium leading-tight font-body cursor-pointer"
                    >
                        By submitting this form and signing up for texts, you
                        consent to receive text messages from Solomon Electric,
                        LLC at the number provided, including messages sent by
                        auto dialer. Consent is not a condition of purchase. Msg
                        &amp; data rates may apply. Msg frequency varies.
                        Unsubscribe at any time by replying STOP or clicking the
                        unsubscribe link (where available) and no further
                        messages will be sent. Reply HELP for help.
                    </label>
                </div>
                <!-- Legal Links - Outside the label to satisfy accessibility & validation -->
                <div
                    class="flex items-center gap-2 text-[length:var(--text-caption)] font-body ml-6"
                >
                    <button
                        type="button"
                        class="legal-link text-accent hover:underline font-medium"
                        data-modal="privacy">Privacy Policy</button
                    >
                    <span class="text-gray-400">|</span>
                    <button
                        type="button"
                        class="legal-link text-accent hover:underline font-medium"
                        data-modal="terms">Terms &amp; Conditions</button
                    >
                </div>
            </div>

            <div class="mt-auto pt-8 flex justify-center">
                <Button type="submit" variant="primary" size="lg">
                    Submit Request
                </Button>
            </div>
        </div>

        <!-- Trust & Security Badges - Always Visible -->
        <div
            class="px-[var(--spacing-lg)] md:px-[var(--spacing-xl)] py-4 bg-gray-50/50 border-t border-gray-100"
        >
            <div
                class="flex flex-wrap items-center justify-center gap-4 text-[length:var(--text-caption)]"
            >
                <!-- SSL Badge -->
                <div
                    class="flex items-center gap-1.5 text-[var(--color-primary-dark)]"
                >
                    <div
                        class="w-5 h-5 rounded-[var(--radius-full)] bg-[var(--color-accent)]/10 flex items-center justify-center flex-shrink-0"
                    >
                        <svg
                            class="w-3 h-3 text-[var(--color-accent)]"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="font-semibold font-secondary"
                        >Secure &amp; Encrypted</span
                    >
                </div>

                <div class="w-px h-4 bg-gray-300 hidden sm:block"></div>

                <!-- Privacy Badge -->
                <div class="flex items-center gap-1.5 text-gray-900">
                    <div
                        class="w-5 h-5 rounded-full bg-accent/10 flex items-center justify-center flex-shrink-0"
                    >
                        <svg
                            class="w-3 h-3 text-accent"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="font-semibold font-body">Never Shared</span>
                </div>

                <div class="w-px h-4 bg-gray-300 hidden sm:block"></div>

                <!-- Licensed Badge -->
                <div class="flex items-center gap-1.5 text-gray-900">
                    <div
                        class="w-5 h-5 rounded-full bg-accent/10 flex items-center justify-center flex-shrink-0"
                    >
                        <svg
                            class="w-3 h-3 text-accent"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="font-semibold font-body"
                        >Licensed Professional</span
                    >
                </div>
            </div>
        </div>

        <!-- Success Message (Hidden by default) -->
        <div
            id={getPrefixedId("formSuccess")}
            class="hidden p-[var(--spacing-xl)] text-center relative"
            role="status"
            aria-live="polite"
        >
            <!-- Decorative Background -->
            <div
                class="absolute inset-0 bg-gradient-to-br from-green-50 to-cyan-50/30 -z-10"
            >
            </div>

            <div
                class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-500 rounded-[var(--radius-full)] flex items-center justify-center mx-auto mb-6 shadow-[var(--shadow-lg)] relative"
            >
                <!-- Animated Ring -->
                <div
                    class="absolute inset-0 rounded-[var(--radius-full)] border-4 border-green-400 animate-ping opacity-75"
                >
                </div>

                <svg
                    class="w-10 h-10 text-white relative z-10"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="3"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3
                class="text-[length:var(--text-h3)] font-black text-primary mb-3 font-display uppercase"
            >
                Request Received!
            </h3>
            <p
                class="text-[var(--clr-body)] mb-2 text-[length:var(--text-body)]"
            >
                We'll contact you promptly during business hours.
            </p>
            <p
                class="text-[var(--clr-muted)] text-[length:var(--text-label)] mb-8"
            >
                Expect to hear from us within 30 minutes during operating hours.
            </p>
            <Button
                type="button"
                variant="secondary"
                size="md"
                class="reset-form-btn"
            >
                Submit Another Request
            </Button>
        </div>

        <!-- Error Message (Hidden by default) -->
        <div
            id={getPrefixedId("formError")}
            class="hidden p-6 mx-[var(--spacing-lg)] mb-[var(--spacing-lg)] bg-gradient-to-br from-red-50 to-red-100/50 border-l-4 border-red-500 rounded-[var(--radius-sm)] shadow-[var(--shadow-lg)]"
            role="alert"
            aria-live="assertive"
        >
            <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                    <svg
                        class="w-6 h-6 text-red-500"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                            clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h4
                        class="text-red-800 font-bold text-[length:var(--text-label)] uppercase tracking-wide font-secondary mb-1"
                    >
                        Error
                    </h4>
                    <p
                        class="text-red-700 font-medium text-[length:var(--text-label)]"
                        id={getPrefixedId("errorMessage")}
                    >
                        Something went wrong. Please try again.
                    </p>
                </div>
            </div>
        </div>
    </form>

    <!-- Legal Modal -->
    <div
        id={getPrefixedId("legalModal")}
        class="fixed inset-0 z-50 hidden items-center justify-center p-4"
        role="dialog"
        aria-modal="true"
        aria-labelledby={getPrefixedId("modalTitle")}
    >
        <!-- Backdrop -->
        <div
            class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"
        >
        </div>

        <!-- Modal Content -->
        <div
            class="modal-content relative bg-white rounded-[var(--radius-lg)] shadow-[var(--shadow-xl)] w-full max-w-4xl max-h-[80vh] flex flex-col overflow-hidden transform transition-all"
        >
            <!-- Modal Header -->
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50"
            >
                <h3
                    id={getPrefixedId("modalTitle")}
                    class="text-[length:var(--text-body)] font-bold text-primary font-display uppercase tracking-wide"
                >
                    Privacy Policy
                </h3>
                <button
                    type="button"
                    class="modal-close p-2 rounded-[var(--radius-full)] hover:bg-gray-200 transition-colors text-gray-500 hover:text-gray-700"
                    aria-label="Close modal"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div
                id={getPrefixedId("modalBody")}
                class="flex-1 overflow-y-auto p-6"
            >
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-full mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div
                class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end"
            >
                <button
                    type="button"
                    class="modal-close px-6 py-2 bg-[var(--color-primary)] text-white font-bold uppercase text-[length:var(--text-label)] tracking-wide rounded-[var(--radius-sm)] hover:bg-[var(--color-primary-dark)] transition-all active:scale-95"
                >
                    Close
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Header Gradient */
        .header-gradient {
            background: linear-gradient(
                135deg,
                var(--color-primary-darker) 0%,
                var(--color-primary-dark) 100%
            );
            position: relative;
        }

        /* Glow Pulse Animation */
        @keyframes glowPulse {
            0%,
            100% {
                opacity: 0.6;
                transform: scaleX(1);
            }
            50% {
                opacity: 1;
                transform: scaleX(1.1);
            }
        }
        .glow-pulse {
            animation: glowPulse 2s ease-in-out infinite;
        }

        /* Step Progress Indicator */
        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            transition: all var(--transition-base);
        }

        .step-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);

            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.6);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .step-icon {
                width: 3rem;
                height: 3rem;
            }
        }

        .step-icon::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(
                circle,
                rgba(var(--color-accent-rgb), 0.3) 0%,
                transparent 70%
            );
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .step-indicator.active .step-icon {
            background: linear-gradient(
                135deg,
                var(--color-accent) 0%,
                var(--color-accent-dark) 100%
            );
            border-color: var(--color-accent);
            color: white;
            box-shadow:
                0 0 20px rgba(var(--color-accent-rgb), 0.5),
                0 4px 12px rgba(0, 0, 0, 0.15);
            transform: scale(1.1);
        }

        .step-indicator.active .step-icon::before {
            opacity: 1;
            animation: ripple 1.5s ease-out infinite;
        }

        .step-indicator.completed .step-icon {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .step-label {
            display: none;
            font-size: var(--text-caption);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.6);
            transition: color var(--transition-base);
        }

        @media (min-width: 480px) {
            .step-label {
                display: block;
            }
        }

        .step-indicator.active .step-label {
            color: var(--color-accent);
        }

        .step-indicator.completed .step-label {
            color: var(--color-success);
        }

        .step-line {
            width: 2rem;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .step-line::after {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(
                90deg,
                var(--color-accent),
                var(--color-accent-dark)
            );
            transition: width var(--transition-slow);
        }

        .step-line.completed::after {
            width: 100%;
        }

        /* Form Step Transitions */
        .form-step {
            transition:
                opacity var(--transition-base),
                transform var(--transition-base);
        }

        .form-step.hidden {
            display: none;
            opacity: 0;
            transform: translateX(20px);
        }

        .form-step.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
            animation: fadeInUp var(--transition-base);
        }

        /* Enhanced Input Styles */
        input:focus,
        select:focus,
        textarea:focus {
            box-shadow:
                0 0 0 3px rgba(var(--color-accent-rgb), 0.1),
                0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* Validation States */
        input.border-red-500,
        select.border-red-500,
        textarea.border-red-500 {
            animation: shake var(--transition-slow) ease-in-out;
            border-color: var(--color-error) !important;
        }

        input.valid,
        select.valid,
        textarea.valid {
            border-color: var(--color-success);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2310B581' stroke-width='3'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M5 13l4 4L19 7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem;
        }

        /* Success State Animation */
        #formSuccess {
            animation: successFadeIn var(--transition-slow)
                cubic-bezier(0.4, 0, 0.2, 1);
        }

        #formSuccess .w-16.h-16 {
            animation: checkmarkBounce var(--transition-slow) var(--ease-bounce);
        }

        /* Button Hover Effects */
        button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(var(--color-accent-rgb), 0.25);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        /* Loading Spinner */
    </style>

    <script>
        import {
            formatPhoneNumber,
            isValidUSPhone,
            capitalizeName,
            isValidEmail,
        } from "../utils/form-validation";
        import {
            collectTrackingData,
            buildTrackingPayload,
        } from "../utils/form-tracking";

        // Load Google Maps Script dynamically
        const loadGoogleMaps = (apiKey) => {
            const existingScript =
                document.getElementById("google-maps-script");
            if (existingScript) return;

            const script = document.createElement("script");
            script.id = "google-maps-script";
            if (!apiKey) {
                console.warn(
                    "Google Maps API key not configured. Address autocomplete disabled.",
                );
                return;
            }
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&loading=async&callback=initAutocomplete`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        };

        // Make initAutocomplete globally available
        window.initAutocomplete = () => {
            // Find all address inputs and initialize them
            const addressInputs = document.querySelectorAll(
                'input[name="address"]',
            );
            addressInputs.forEach((addressInput) => {
                const container = addressInput.closest(
                    ".booking-form-container",
                );
                if (!container) return;
                const prefix = container.getAttribute("data-id-prefix");
                const getPrefixedId = (id) => `${prefix}-${id}`;

                const google = window.google;
                if (!google) return;

                const autocomplete = new google.maps.places.Autocomplete(
                    addressInput,
                    {
                        types: ["address"],
                        componentRestrictions: { country: "us" }, // Restrict to US
                    },
                );

                autocomplete.addListener("place_changed", () => {
                    const place = autocomplete.getPlace();
                    if (!place.geometry) {
                        return;
                    }

                    // Extract address components for CRM
                    const components = place.address_components || [];
                    let streetNumber = "";
                    let streetName = "";
                    let city = "";
                    let state = "";
                    let zipCode = "";

                    components.forEach((component) => {
                        const types = component.types;
                        if (types.includes("street_number")) {
                            streetNumber = component.long_name;
                        } else if (types.includes("route")) {
                            streetName = component.long_name;
                        } else if (types.includes("locality")) {
                            city = component.long_name;
                        } else if (
                            types.includes("administrative_area_level_1")
                        ) {
                            state = component.short_name;
                        } else if (types.includes("postal_code")) {
                            zipCode = component.long_name;
                        }
                    });

                    // Fill hidden fields for CRM
                    const streetNumberInput = container.querySelector(
                        `#${getPrefixedId("streetNumber")}`,
                    );
                    const streetNameInput = container.querySelector(
                        `#${getPrefixedId("streetName")}`,
                    );
                    const cityInput = container.querySelector(
                        `#${getPrefixedId("city")}`,
                    );
                    const stateInput = container.querySelector(
                        `#${getPrefixedId("state")}`,
                    );
                    const zipCodeInput = container.querySelector(
                        `#${getPrefixedId("zipCode")}`,
                    );

                    if (streetNumberInput)
                        streetNumberInput.value = streetNumber;
                    if (streetNameInput) streetNameInput.value = streetName;
                    if (cityInput) cityInput.value = city;
                    if (stateInput) stateInput.value = state;
                    if (zipCodeInput) zipCodeInput.value = zipCode;

                    // Show address fields when autocomplete is used
                    const addressFieldsContainer = container.querySelector(
                        `#${getPrefixedId("addressFieldsContainer")}`,
                    );
                    if (addressFieldsContainer) {
                        addressFieldsContainer.classList.remove("hidden");
                    }
                });
            });
        };

        // Load Google reCAPTCHA v3 Script dynamically
        const loadRecaptcha = (key) => {
            const existingScript = document.getElementById("recaptcha-script");
            if (existingScript) return;

            const script = document.createElement("script");
            script.id = "recaptcha-script";
            script.src =
                "https://www.google.com/recaptcha/api.js?render=" + key;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        };

        // Load scripts on mount - trigger on interaction for better performance
        let scriptsLoaded = false;
        const initScripts = (container) => {
            if (scriptsLoaded) return;
            const gmapsKey = container.getAttribute("data-gmaps-key");
            const recaptchaKey = container.getAttribute("data-recaptcha-key");
            loadGoogleMaps(gmapsKey);
            loadRecaptcha(recaptchaKey);
            scriptsLoaded = true;
        };

        // Initialize each form instance
        document
            .querySelectorAll(".booking-form-container")
            .forEach((container) => {
                const prefix = container.getAttribute("data-id-prefix");
                const getPrefixedId = (id) => `${prefix}-${id}`;
                const gmapsKey = container.getAttribute("data-gmaps-key");
                const recaptchaKey =
                    container.getAttribute("data-recaptcha-key");

                // Initialize scripts on interaction for this specific form
                ["focusin", "touchstart", "mouseover"].forEach((event) => {
                    container
                        .querySelector(`#${getPrefixedId("bookingForm")}`)
                        ?.addEventListener(
                            event,
                            () => initScripts(container),
                            { once: true },
                        );
                });

                const form = container.querySelector(
                    `#${getPrefixedId("bookingForm")}`,
                );
                if (!form) return;

                const steps = container.querySelectorAll(".form-step");
                const nextBtns = container.querySelectorAll(".next-step-btn");
                const prevBtns = container.querySelectorAll(".prev-step-btn");
                const submitBtn = form.querySelector('button[type="submit"]');

                // =====================================================
                // FORM INPUT FORMATTING UTILITIES (Imported)
                // =====================================================
                const showFieldError = (input, message) => {
                    input.classList.add("border-red-500", "focus:ring-red-500");
                    input.classList.remove("focus:ring-[var(--color-accent)]");
                    input.setAttribute("aria-invalid", "true");

                    let errorEl =
                        input.parentElement?.querySelector(".field-error");
                    if (!errorEl) {
                        errorEl = document.createElement("p");
                        errorEl.className =
                            "field-error text-red-500 text-xs mt-1 font-medium";
                        errorEl.id = `${input.id}-error`;
                        input.parentElement?.appendChild(errorEl);
                        input.setAttribute("aria-describedby", errorEl.id);
                    }
                    errorEl.textContent = message;
                };

                const clearFieldError = (input) => {
                    input.classList.remove(
                        "border-red-500",
                        "focus:ring-red-500",
                    );
                    input.classList.add("focus:ring-[var(--color-accent)]");
                    input.removeAttribute("aria-invalid");
                    input.removeAttribute("aria-describedby");
                    const errorEl =
                        input.parentElement?.querySelector(".field-error");
                    if (errorEl) errorEl.remove();
                };

                // Move all input handlers inside this block
                const phoneInput = container.querySelector(
                    `#${getPrefixedId("phone")}`,
                );
                if (phoneInput) {
                    phoneInput.addEventListener("input", (e) => {
                        const target = e.target;
                        const cursorPos = target.selectionStart || 0;
                        const prevLen = target.value.length;
                        target.value = formatPhoneNumber(target.value);
                        const newLen = target.value.length;
                        const newPos = cursorPos + (newLen - prevLen);
                        target.setSelectionRange(newPos, newPos);

                        if (target.value && !isValidUSPhone(target.value)) {
                            showFieldError(
                                target,
                                "Please enter a valid 10-digit US phone number",
                            );
                        } else {
                            clearFieldError(target);
                        }
                    });
                }

                const nameInput = container.querySelector(
                    `#${getPrefixedId("name")}`,
                );
                if (nameInput) {
                    nameInput.addEventListener("blur", () => {
                        if (nameInput.value.trim()) {
                            nameInput.value = capitalizeName(
                                nameInput.value.trim(),
                            );
                        }
                    });
                }

                const emailInput = container.querySelector(
                    `#${getPrefixedId("email")}`,
                );
                if (emailInput) {
                    emailInput.addEventListener("blur", () => {
                        if (emailInput.value) {
                            emailInput.value = emailInput.value
                                .trim()
                                .toLowerCase();
                            if (!isValidEmail(emailInput.value)) {
                                showFieldError(
                                    emailInput,
                                    "Please enter a valid email address",
                                );
                            } else {
                                clearFieldError(emailInput);
                            }
                        }
                    });
                }

                // =====================================================
                // FORM INPUT HANDLERS
                // =====================================================

                // Service details capitalization
                const detailsInput = container.querySelector(
                    `#${getPrefixedId("serviceDetails")}`,
                );
                if (detailsInput) {
                    detailsInput.addEventListener("blur", () => {
                        if (detailsInput.value.trim()) {
                            // Capitalize first letter of each sentence
                            detailsInput.value = detailsInput.value
                                .trim()
                                .replace(/(^\s*\w|[.!?]\s*\w)/g, (c) =>
                                    c.toUpperCase(),
                                );
                        }
                    });
                }

                // =====================================================
                // LEGAL MODAL FUNCTIONALITY
                // =====================================================

                const legalModal = container.querySelector(
                    `#${getPrefixedId("legalModal")}`,
                );
                const modalTitle = container.querySelector(
                    `#${getPrefixedId("modalTitle")}`,
                );
                const modalBody = container.querySelector(
                    `#${getPrefixedId("modalBody")}`,
                );
                const legalLinks = container.querySelectorAll(".legal-link");
                const modalCloseButtons =
                    container.querySelectorAll(".modal-close");
                const modalBackdrop =
                    container.querySelector(".modal-backdrop");

                const legalContent = {
                    privacy: {
                        title: "Privacy Policy",
                        content: `
                        <h4 class="font-bold text-primary mb-3 font-secondary">Information We Collect</h4>
                        <p class="mb-4 text-gray-600">We collect information you provide directly, including your name, phone number, email address, and service request details.</p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">How We Use Your Information</h4>
                        <p class="mb-4 text-gray-600">Your information is used to respond to your service requests, schedule appointments, and provide customer support. We may also use it to send service updates and promotional communications.</p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">SMS/Text Message Communications</h4>
                        <p class="mb-4 text-gray-600">By submitting our contact form and signing up for texts, you consent to receive text messages from Solomon Electric, LLC at the number provided, including messages sent by auto dialer. Consent is not a condition of purchase. Msg & data rates may apply. Msg frequency varies. Unsubscribe at any time by replying STOP or clicking the unsubscribe link (where available) and no further messages will be sent. Reply HELP for help.</p>
                        <p class="mb-4 text-gray-600">Solomon Electric, LLC may collect opt-in verbally from customers in person or over the phone. Customers will be verbally informed that message and data rates may apply, message frequency may vary, they can text HELP for support and STOP to unsubscribe.</p>
                        <p class="mb-4 text-gray-600"><strong>Your phone number and consent data will not be shared with third parties for marketing purposes.</strong></p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">Information Sharing</h4>
                        <p class="mb-4 text-gray-600">We do not sell your personal information. We may share information with service providers who assist in our operations, or as required by law.</p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">Data Security</h4>
                        <p class="mb-4 text-gray-600">We implement appropriate security measures to protect your personal information from unauthorized access, alteration, or disclosure.</p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">Contact Us</h4>
                        <p class="text-gray-600">For questions about this Privacy Policy, contact us at (786)&nbsp;833&#8209;9211 or contactus@solomonselectric.com.</p>
                    `,
                    },
                    terms: {
                        title: "Terms & Conditions",
                        content: `
                        <h4 class="font-bold text-primary mb-3 font-secondary">Service Agreement</h4>
                        <p class="mb-4 text-gray-600">By submitting a service request, you agree to allow Solomon Electric to contact you regarding your request via phone, email, or text message.</p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">Estimates & Pricing</h4>
                        <p class="mb-4 text-gray-600">All estimates are provided free of charge. Final pricing may vary based on actual work required and will be confirmed before any work begins.</p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">Service Hours</h4>
                        <p class="mb-4 text-gray-600">Standard business hours are Monday-Friday, 8AM-6PM. Emergency services are available 24/7 and may incur additional fees.</p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">SMS/Text Message Terms</h4>
                        <p class="mb-4 text-gray-600">You may receive appointment reminders, technician dispatch notifications, service completion updates, billing reminders, and customer satisfaction surveys via SMS. You may opt out of receiving text messages at any time by replying STOP. Reply HELP for help.</p>
                        <p class="mb-4 text-gray-600">Standard message and data rates may apply. Message frequency varies based on your service activity.</p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">Licensing & Insurance</h4>
                        <p class="mb-4 text-gray-600">Solomon Electric is fully licensed ({SITE_CONFIG.credentials.license.number}) and insured. All work is performed according to local codes and regulations.</p>

                        <h4 class="font-bold text-primary mb-3 font-secondary">Warranty</h4>
                        <p class="text-gray-600">We stand behind our work. All electrical services come with a satisfaction guarantee. Specific warranty terms will be provided with your service agreement.</p>
                    `,
                    },
                };

                const openModal = (type) => {
                    if (!legalModal || !modalTitle || !modalBody) return;
                    const content = legalContent[type];
                    if (!content) return;

                    modalTitle.textContent = content.title;
                    modalBody.innerHTML = content.content;
                    legalModal.classList.remove("hidden");
                    legalModal.classList.add("flex");
                    document.body.style.overflow = "hidden";

                    // Focus first button after opening
                    setTimeout(() => {
                        const closeBtn =
                            legalModal.querySelector(".modal-close");
                        if (closeBtn instanceof HTMLElement) {
                            closeBtn.focus();
                        }
                    }, 10);
                };

                const closeModal = () => {
                    if (!legalModal) return;
                    legalModal.classList.add("hidden");
                    legalModal.classList.remove("flex");
                    document.body.style.overflow = "";
                };

                legalLinks.forEach((link) => {
                    link.addEventListener("click", () => {
                        const modalType = link.getAttribute("data-modal");
                        if (modalType) openModal(modalType);
                    });
                });

                modalCloseButtons.forEach((btn) => {
                    btn.addEventListener("click", closeModal);
                });

                if (modalBackdrop) {
                    modalBackdrop.addEventListener("click", closeModal);
                }

                // Close on Escape key
                document.addEventListener("keydown", (e) => {
                    if (
                        e.key === "Escape" &&
                        !legalModal?.classList.contains("hidden")
                    ) {
                        closeModal();
                    }
                });

                // Conditional field displays
                const serviceTypeSelect = container.querySelector(
                    `#${getPrefixedId("serviceType")}`,
                );
                // Note: additionalDetailsContainer is no longer used - notes field is always visible
                const addressInputField = container.querySelector(
                    `#${getPrefixedId("address")}`,
                );
                const addressFieldsContainer = container.querySelector(
                    `#${getPrefixedId("addressFieldsContainer")}`,
                );

                // Note: additionalDetailsContainer is now always visible (no service selection required)

                // Show address fields after address is entered
                if (addressInputField && addressFieldsContainer) {
                    // Check address completion
                    const checkAddressComplete = () => {
                        if (addressInputField.value.trim().length > 10) {
                            addressFieldsContainer.classList.remove("hidden");
                        }
                    };

                    // Check on blur (manual entry)
                    addressInputField.addEventListener(
                        "blur",
                        checkAddressComplete,
                    );

                    // Check on input (with debounce)
                    let addressTimeout;
                    addressInputField.addEventListener("input", () => {
                        clearTimeout(addressTimeout);
                        addressTimeout = setTimeout(checkAddressComplete, 500);
                    });
                }

                let currentStep = 1;

                function showStep(step) {
                    steps.forEach((s) => {
                        if (s instanceof HTMLElement) {
                            const stepNum = parseInt(s.dataset.step || "0");
                            if (stepNum === step) {
                                s.classList.remove("hidden");
                                s.classList.add("active");
                            } else {
                                s.classList.add("hidden");
                                s.classList.remove("active");
                            }
                        }
                    });
                    currentStep = step;

                    // Lazy load scripts based on step
                    if (step === 2) {
                        loadGoogleMaps();
                    } else if (step === 3) {
                        loadRecaptcha();
                    }

                    // Update progress indicator
                    const progressIndicators =
                        container.querySelectorAll(".step-indicator");
                    const stepLines = container.querySelectorAll(".step-line");

                    progressIndicators.forEach((indicator) => {
                        if (indicator instanceof HTMLElement) {
                            const indicatorStep = parseInt(
                                indicator.dataset.step || "0",
                            );
                            indicator.classList.remove("active", "completed");

                            if (indicatorStep === step) {
                                indicator.classList.add("active");
                            } else if (indicatorStep < step) {
                                indicator.classList.add("completed");
                            }
                        }
                    });

                    // Update step lines
                    stepLines.forEach((line, index) => {
                        if (index < step - 1) {
                            line.classList.add("completed");
                        } else {
                            line.classList.remove("completed");
                        }
                    });
                }

                function validateStep(step) {
                    const currentStepEl = container.querySelector(
                        `.form-step[data-step="${step}"]`,
                    );
                    if (!currentStepEl) return false;

                    const inputs = currentStepEl.querySelectorAll(
                        "input[required], select[required], textarea[required]",
                    );
                    let isValid = true;

                    inputs.forEach((input) => {
                        if (
                            input instanceof HTMLInputElement ||
                            input instanceof HTMLSelectElement ||
                            input instanceof HTMLTextAreaElement
                        ) {
                            // Handle checkboxes (used in Step 3 for consent)
                            if (
                                input.type === "checkbox" &&
                                input instanceof HTMLInputElement
                            ) {
                                if (!input.checked) {
                                    isValid = false;
                                    // Visual feedback could be added here
                                }
                            }
                            // Handle all other input types
                            else if (!input.value.trim()) {
                                isValid = false;
                                input.classList.add("border-red-500");
                            } else {
                                input.classList.remove("border-red-500");
                            }

                            input.addEventListener("input", () => {
                                input.classList.remove("border-red-500");
                            });
                            input.addEventListener("change", () => {
                                input.classList.remove("border-red-500");
                            });
                        }
                    });

                    return isValid;
                }

                nextBtns.forEach((btn) => {
                    btn.addEventListener("click", () => {
                        if (validateStep(currentStep)) {
                            showStep(currentStep + 1);
                        }
                    });
                });

                prevBtns.forEach((btn) => {
                    btn.addEventListener("click", () => {
                        showStep(currentStep - 1);
                    });
                });

                // Form submission with reCAPTCHA v3
                form.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    if (!validateStep(currentStep)) return;

                    const successEl = container.querySelector(
                        `#${getPrefixedId("formSuccess")}`,
                    );
                    const errorEl = container.querySelector(
                        `#${getPrefixedId("formError")}`,
                    );
                    const errorMsg = container.querySelector(
                        `#${getPrefixedId("errorMessage")}`,
                    );

                    // Hide any previous messages
                    if (errorEl) errorEl.classList.add("hidden");

                    // Disable button and show loading
                    if (submitBtn) {
                        /** @type {HTMLButtonElement} */ (submitBtn).disabled =
                            true;
                        /** @type {HTMLButtonElement} */ (submitBtn).innerHTML =
                            `
                    <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Sending...
                `;
                    }

                    try {
                        // Get reCAPTCHA v3 token
                        const grecaptcha = window.grecaptcha;
                        let recaptchaVerified = false;
                        if (grecaptcha) {
                            try {
                                // Ensure grecaptcha is ready
                                if (typeof grecaptcha.ready === "function") {
                                    await new Promise((resolve) =>
                                        grecaptcha.ready(resolve),
                                    );
                                    const token = await grecaptcha.execute(
                                        recaptchaKey,
                                        { action: "submit" },
                                    );

                                    // Add token to form
                                    const tokenInput =
                                        document.createElement("input");
                                    tokenInput.type = "hidden";
                                    tokenInput.name = "g-recaptcha-response";
                                    tokenInput.value = token;
                                    form.appendChild(tokenInput);
                                    recaptchaVerified = true;
                                }
                            } catch (err) {
                                console.error("reCAPTCHA error:", err);
                            }
                        }

                        // Collect analytics tracking data using shared utility
                        const trackingData = collectTrackingData();
                        const trackingPayload =
                            buildTrackingPayload(trackingData);

                        // Add tracking data as hidden fields
                        Object.entries(trackingPayload).forEach(
                            ([name, value]) => {
                                const input = document.createElement("input");
                                input.type = "hidden";
                                input.name = name;
                                input.value = value;
                                form.appendChild(input);
                            },
                        );

                        const formData = new FormData(form);

                        // Submit to PHP backend (SMTP2GO integration)
                        const response = await fetch("/api/send-email.php", {
                            method: "POST",
                            body: formData,
                        });

                        const result = await response.json();

                        if (response.ok) {
                            // Push conversion event to GTM dataLayer
                            if (
                                typeof window !== "undefined" &&
                                window.dataLayer
                            ) {
                                window.dataLayer.push({
                                    event: "form_submission",
                                    form_type: "booking_form",
                                    service_type: formData.get("serviceType"),
                                    urgency: formData.get("urgency"),
                                    city: formData.get("city") || "Unknown",
                                });
                            }

                            // Set flag for thank-you page validation
                            sessionStorage.setItem("formSubmitted", "true");
                            // Redirect to thank-you page for lead tracking
                            window.location.href = "/thank-you";
                        } else {
                            // Show error message
                            if (errorEl && errorMsg) {
                                errorMsg.textContent =
                                    result.message ||
                                    "Something went wrong. Please try again.";
                                errorEl.classList.remove("hidden");
                            }
                        }
                    } catch (err) {
                        if (errorEl && errorMsg) {
                            errorMsg.textContent =
                                "Network error. Please check your connection and try again.";
                            errorEl.classList.remove("hidden");
                        }
                    } finally {
                        if (submitBtn) {
                            /** @type {HTMLButtonElement} */ (
                                submitBtn
                            ).disabled = false;
                            /** @type {HTMLButtonElement} */ (
                                submitBtn
                            ).innerText = "Submit Request";
                        }
                    }
                });

                // Reset form button handler
                const resetBtn = container.querySelector(".reset-form-btn");
                if (resetBtn) {
                    resetBtn.addEventListener("click", () => {
                        const successEl = container.querySelector(
                            `#${getPrefixedId("formSuccess")}`,
                        );
                        if (successEl) successEl.classList.add("hidden");
                        form.classList.remove("hidden");
                        showStep(1);
                    });
                }
            });
    </script>
</div>
