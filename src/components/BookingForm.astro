---
import Button from "./ui/Button.astro";
import { MapPin, User, Clipboard, ArrowRight, ChevronLeft } from "lucide-astro";

// Props if needed
---

<div
    class="booking-form-container bg-white/95 backdrop-blur-sm shadow-[0_20px_60px_rgba(20,211,227,0.15)] overflow-hidden relative z-20 border-l-4 border-l-accent rounded-sm"
>
    <!-- Animated Background Pattern -->
    <div class="absolute inset-0 opacity-5 pointer-events-none">
        <div
            class="absolute top-0 right-0 w-64 h-64 bg-accent rounded-full filter blur-3xl animate-pulse"
        >
        </div>
        <div
            class="absolute bottom-0 left-0 w-48 h-48 bg-primary rounded-full filter blur-3xl animate-pulse"
            style="animation-delay: 1s;"
        >
        </div>
    </div>

    <!-- Decorative Corner Elements -->
    <div
        class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-accent/20 via-accent/10 to-transparent pointer-events-none"
    >
    </div>
    <div
        class="absolute bottom-0 left-0 w-32 h-32 bg-gradient-to-tr from-primary/10 to-transparent pointer-events-none"
    >
    </div>

    <!-- Enhanced Header -->
    <div
        class="header-gradient p-[var(--spacing-lg)] text-center relative overflow-hidden"
    >
        <!-- Animated Accent Strip -->
        <div
            class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-accent to-transparent glow-pulse"
        >
        </div>

        <h2
            class="text-white text-xl md:text-2xl font-black uppercase tracking-wider font-display mb-2"
        >
            Request Service
        </h2>
        <p
            class="text-accent text-sm font-bold uppercase tracking-widest font-display flex items-center justify-center gap-2"
        >
            <svg
                class="w-4 h-4 animate-pulse"
                fill="currentColor"
                viewBox="0 0 20 20"
            >
                <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                    clip-rule="evenodd"></path>
            </svg>
            Fast Response Guaranteed
        </p>

        <!-- Step Progress Indicator -->
        <div
            class="mt-6 flex items-center justify-center gap-2"
            id="progressIndicator"
        >
            <div class="step-indicator active" data-step="1">
                <div class="step-icon">
                    <Clipboard class="w-4 h-4" />
                </div>
                <span class="step-label">Service</span>
            </div>
            <div class="step-line"></div>
            <div class="step-indicator" data-step="2">
                <div class="step-icon">
                    <MapPin class="w-4 h-4" />
                </div>
                <span class="step-label">Location</span>
            </div>
            <div class="step-line"></div>
            <div class="step-indicator" data-step="3">
                <div class="step-icon">
                    <User class="w-4 h-4" />
                </div>
                <span class="step-label">Contact</span>
            </div>
        </div>
    </div>

    <form
        id="bookingForm"
        class="p-[var(--spacing-lg)] md:p-[var(--spacing-xl)] relative min-h-[400px] flex flex-col"
    >
        <!-- Step 1: Service Details -->
        <div class="form-step active flex-grow" data-step="1">
            <div class="mb-6">
                <label
                    for="serviceType"
                    class="block text-primary font-bold uppercase text-xs mb-2 tracking-wide font-secondary"
                >
                    Service Needed
                </label>
                <select
                    id="serviceType"
                    name="serviceType"
                    required
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all cursor-pointer appearance-none font-body"
                >
                    <option value="" disabled selected
                        >Select a service...</option
                    >
                    <option value="electrical_repair">Electrical Repair</option>
                    <option value="panel_upgrade">Panel Upgrade</option>
                    <option value="lighting_installation"
                        >Lighting Installation</option
                    >
                    <option value="outlet_switch">Outlet / Switch Issue</option>
                    <option value="ev_charger">EV Charger Installation</option>
                    <option value="generator">Generator Service</option>
                    <option value="inspection">Safety Inspection</option>
                    <option value="other">Other</option>
                </select>
                <div
                    class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none mt-8 mr-6"
                >
                    <svg
                        class="w-4 h-4 text-[var(--text-muted)]"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 9l-7 7-7-7"></path></svg
                    >
                </div>
            </div>

            <div id="additionalDetailsContainer" class="mb-6 hidden">
                <label
                    for="serviceDetails"
                    class="block text-primary font-bold uppercase text-xs mb-2 tracking-wide font-display"
                >
                    Additional Details <span
                        class="text-gray-400 normal-case font-normal"
                        >(Optional)</span
                    >
                </label>
                <textarea
                    id="serviceDetails"
                    name="serviceDetails"
                    rows="4"
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all resize-none font-body"
                    placeholder="Describe your issue or project..."></textarea>
            </div>

            <div class="mt-auto pt-8 flex justify-center">
                <Button
                    type="button"
                    variant="primary"
                    size="lg"
                    class="next-step-btn flex items-center justify-center gap-2 group"
                >
                    Continue
                    <ArrowRight
                        class="w-5 h-5 group-hover:translate-x-1 transition-transform"
                    />
                </Button>
            </div>
        </div>

        <!-- Step 2: Location & Urgency -->
        <div class="form-step hidden flex-grow" data-step="2">
            <button
                type="button"
                class="prev-step-btn text-gray-400 hover:text-primary mb-4 flex items-center gap-1 text-sm font-bold uppercase tracking-wide transition-colors font-display"
            >
                <ChevronLeft class="w-4 h-4" />
                Back
            </button>

            <div class="mb-4">
                <label
                    for="address"
                    class="block text-primary font-bold uppercase text-xs mb-2 tracking-wide font-display"
                >
                    Service Address
                </label>
                <input
                    type="text"
                    id="address"
                    name="address"
                    required
                    autocomplete="off"
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all font-body"
                    placeholder="Start typing your address..."
                />
                <!-- Hidden fields for CRM address components -->
                <input type="hidden" id="streetNumber" name="streetNumber" />
                <input type="hidden" id="streetName" name="streetName" />
                <input type="hidden" id="city" name="city" />
                <input type="hidden" id="state" name="state" />
                <input type="hidden" id="zipCode" name="zipCode" />
            </div>

            <div
                id="addressFieldsContainer"
                class="grid grid-cols-2 gap-4 mb-6 hidden"
            >
                <div>
                    <label
                        for="aptUnit"
                        class="block text-primary font-bold uppercase text-xs mb-2 tracking-wide font-display"
                    >
                        Apt/Suite # <span
                            class="text-gray-400 normal-case font-normal"
                            >(Opt)</span
                        >
                    </label>
                    <input
                        type="text"
                        id="aptUnit"
                        name="aptUnit"
                        class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all font-body"
                    />
                </div>
                <div>
                    <label
                        for="gateCode"
                        class="block text-primary font-bold uppercase text-xs mb-2 tracking-wide font-display"
                    >
                        Gate Code <span
                            class="text-gray-400 normal-case font-normal"
                            >(Opt)</span
                        >
                    </label>
                    <input
                        type="text"
                        id="gateCode"
                        name="gateCode"
                        class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all font-body"
                    />
                </div>
            </div>

            <div class="mb-6">
                <label
                    for="urgency"
                    class="block text-primary font-bold uppercase text-xs mb-2 tracking-wide font-display"
                >
                    When do you need us?
                </label>
                <select
                    id="urgency"
                    name="urgency"
                    required
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all cursor-pointer appearance-none font-body"
                >
                    <option value="" disabled selected>Select timing...</option>
                    <option value="ASAP">ASAP / Emergency</option>
                    <option value="Today">Today if possible</option>
                    <option value="FewDays">Next few days</option>
                    <option value="Planning">Just planning / Not sure</option>
                </select>
                <div
                    class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none mt-8 mr-6"
                >
                    <svg
                        class="w-4 h-4 text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 9l-7 7-7-7"></path></svg
                    >
                </div>
            </div>

            <div class="mt-auto pt-8 flex justify-center">
                <Button
                    type="button"
                    variant="primary"
                    size="lg"
                    class="next-step-btn flex items-center justify-center gap-2 group"
                >
                    Continue
                    <svg
                        class="w-5 h-5 group-hover:translate-x-1 transition-transform"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                    </svg>
                </Button>
            </div>
        </div>

        <!-- Step 3: Contact Info -->
        <div class="form-step hidden flex-grow" data-step="3">
            <button
                type="button"
                class="prev-step-btn text-gray-400 hover:text-primary mb-4 flex items-center gap-1 text-sm font-bold uppercase tracking-wide transition-colors font-display"
            >
                <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    ><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path></svg
                >
                Back
            </button>

            <div class="mb-4">
                <label
                    for="name"
                    class="block text-primary font-bold uppercase text-xs mb-2 tracking-wide font-display"
                >
                    Full Name
                </label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    required
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all font-body"
                    placeholder="John Doe"
                />
            </div>

            <div class="mb-4">
                <label
                    for="phone"
                    class="block text-primary font-bold uppercase text-xs mb-2 tracking-wide font-display"
                >
                    Phone Number
                </label>
                <input
                    type="tel"
                    id="phone"
                    name="phone"
                    required
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all font-body"
                    placeholder="(305) 555-0123"
                />
            </div>

            <div class="mb-6">
                <label
                    for="email"
                    class="block text-primary font-bold uppercase text-xs mb-2 tracking-wide font-display"
                >
                    Email Address <span
                        class="text-gray-400 normal-case font-normal"
                        >(Opt)</span
                    >
                </label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    class="w-full bg-[var(--bg-surface-hover)] border border-[var(--border-light)] rounded-sm px-4 py-3 text-[var(--text-body)] font-medium focus:outline-none focus:border-[var(--border-focus)] focus:ring-1 focus:ring-[var(--color-accent)] transition-all font-body"
                    placeholder="john@example.com"
                />
            </div>

            <div class="space-y-4 mb-6">
                <label class="flex items-start cursor-pointer group">
                    <input
                        type="checkbox"
                        name="consentFollowUp"
                        required
                        class="mt-1 w-4 h-4 text-accent border-gray-300 rounded focus:ring-accent"
                    />
                    <span
                        class="ml-2 text-xs text-[var(--text-body)] font-medium leading-tight font-secondary"
                    >
                        I agree to be followed up about my request via phone or
                        email.
                    </span>
                </label>

                <label class="flex items-start cursor-pointer group">
                    <input
                        type="checkbox"
                        name="consentPrivacy"
                        required
                        class="mt-1 w-4 h-4 text-accent border-gray-300 rounded focus:ring-accent"
                    />
                    <span
                        class="ml-2 text-xs text-[var(--text-body)] font-medium leading-tight font-body"
                    >
                        I agree to the <a
                            href="/privacy"
                            target="_blank"
                            class="text-accent hover:underline"
                            >Privacy Policy</a
                        > and <a
                            href="/terms"
                            target="_blank"
                            class="text-accent hover:underline"
                            >Terms & Conditions</a
                        >.
                    </span>
                </label>
            </div>

            <div class="mt-auto pt-8 flex justify-center">
                <Button type="submit" variant="primary" size="lg">
                    Submit Request
                </Button>
            </div>
        </div>

        <!-- Trust & Security Badges - Always Visible -->
        <div
            class="px-[var(--spacing-lg)] md:px-[var(--spacing-xl)] py-4 bg-gray-50/50 border-t border-gray-100"
        >
            <div
                class="flex flex-wrap items-center justify-center gap-4 text-xs"
            >
                <!-- SSL Badge -->
                <div class="flex items-center gap-1.5 text-gray-700">
                    <div
                        class="w-5 h-5 rounded-full bg-accent/10 flex items-center justify-center flex-shrink-0"
                    >
                        <svg
                            class="w-3 h-3 text-accent"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="font-semibold font-secondary"
                        >Secure & Encrypted</span
                    >
                </div>

                <div class="w-px h-4 bg-gray-300 hidden sm:block"></div>

                <!-- Privacy Badge -->
                <div class="flex items-center gap-1.5 text-gray-700">
                    <div
                        class="w-5 h-5 rounded-full bg-accent/10 flex items-center justify-center flex-shrink-0"
                    >
                        <svg
                            class="w-3 h-3 text-accent"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="font-semibold font-body">Never Shared</span>
                </div>

                <div class="w-px h-4 bg-gray-300 hidden sm:block"></div>

                <!-- Licensed Badge -->
                <div class="flex items-center gap-1.5 text-gray-700">
                    <div
                        class="w-5 h-5 rounded-full bg-accent/10 flex items-center justify-center flex-shrink-0"
                    >
                        <svg
                            class="w-3 h-3 text-accent"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="font-semibold font-body"
                        >Licensed Professional</span
                    >
                </div>
            </div>
        </div>

        <!-- Success Message (Hidden by default) -->
        <div
            id="formSuccess"
            class="hidden p-[var(--spacing-xl)] text-center relative"
        >
            <!-- Decorative Background -->
            <div
                class="absolute inset-0 bg-gradient-to-br from-green-50 to-cyan-50/30 -z-10"
            >
            </div>

            <div
                class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg relative"
            >
                <!-- Animated Ring -->
                <div
                    class="absolute inset-0 rounded-full border-4 border-green-400 animate-ping opacity-75"
                >
                </div>
                <svg
                    class="w-10 h-10 text-white relative z-10"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="3"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3
                class="text-3xl font-black text-primary mb-3 font-display uppercase"
            >
                Request Received!
            </h3>
            <p class="text-[var(--text-body)] mb-2 text-lg">
                We'll contact you promptly during business hours.
            </p>
            <p class="text-[var(--text-muted)] text-sm mb-8">
                Expect to hear from us within 30 minutes during operating hours.
            </p>
            <Button
                type="button"
                variant="secondary"
                size="md"
                class="reset-form-btn"
            >
                Submit Another Request
            </Button>
        </div>

        <!-- Error Message (Hidden by default) -->
        <div
            id="formError"
            class="hidden p-6 mx-[var(--spacing-lg)] mb-[var(--spacing-lg)] bg-gradient-to-br from-red-50 to-red-100/50 border-l-4 border-red-500 rounded-sm shadow-lg"
        >
            <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                    <svg
                        class="w-6 h-6 text-red-500"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                            clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h4
                        class="text-red-800 font-bold text-sm uppercase tracking-wide font-secondary mb-1"
                    >
                        Error
                    </h4>
                    <p
                        class="text-red-700 font-medium text-sm"
                        id="errorMessage"
                    >
                        Something went wrong. Please try again.
                    </p>
                </div>
            </div>
        </div>
    </form>

    <style>
        /* Header Gradient */
        .header-gradient {
            background: linear-gradient(135deg, #0a1e32 0%, #0f2a47 100%);
            position: relative;
        }

        /* Glow Pulse Animation */
        @keyframes glowPulse {
            0%,
            100% {
                opacity: 0.6;
                transform: scaleX(1);
            }
            50% {
                opacity: 1;
                transform: scaleX(1.1);
            }
        }
        .glow-pulse {
            animation: glowPulse 2s ease-in-out infinite;
        }

        /* Step Progress Indicator */
        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .step-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .step-icon::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(
                circle,
                rgba(20, 211, 227, 0.3) 0%,
                transparent 70%
            );
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .step-indicator.active .step-icon {
            background: linear-gradient(135deg, #14d3e3 0%, #10b8c6 100%);
            border-color: #14d3e3;
            color: white;
            box-shadow:
                0 0 20px rgba(20, 211, 227, 0.5),
                0 4px 12px rgba(0, 0, 0, 0.15);
            transform: scale(1.1);
        }

        .step-indicator.active .step-icon::before {
            opacity: 1;
            animation: ripple 1.5s ease-out infinite;
        }

        .step-indicator.completed .step-icon {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b581;
            color: #10b581;
        }

        .step-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.6);
            transition: color 0.3s ease;
        }

        .step-indicator.active .step-label {
            color: #14d3e3;
        }

        .step-indicator.completed .step-label {
            color: #10b581;
        }

        .step-line {
            width: 2rem;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .step-line::after {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #14d3e3, #10b8c6);
            transition: width 0.5s ease;
        }

        .step-line.completed::after {
            width: 100%;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Form Step Transitions */
        .form-step {
            transition:
                opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-step.hidden {
            display: none;
            opacity: 0;
            transform: translateX(20px);
        }

        .form-step.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
            animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Enhanced Input Styles */
        input:focus,
        select:focus,
        textarea:focus {
            box-shadow:
                0 0 0 3px rgba(20, 211, 227, 0.1),
                0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* Validation States */
        input.border-red-500,
        select.border-red-500,
        textarea.border-red-500 {
            animation: shake 0.5s ease-in-out;
            border-color: #ef4444 !important;
        }

        @keyframes shake {
            0%,
            100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-8px);
            }
            75% {
                transform: translateX(8px);
            }
        }

        input.valid,
        select.valid,
        textarea.valid {
            border-color: #10b581;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2310B581' stroke-width='3'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M5 13l4 4L19 7'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem;
        }

        /* Success State Animation */
        #formSuccess {
            animation: successFadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes successFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #formSuccess .w-16.h-16 {
            animation: checkmarkBounce 0.8s
                cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes checkmarkBounce {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Button Hover Effects */
        button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(20, 211, 227, 0.25);
        }

        button:active {
            transform: translateY(0);
        }

        /* Loading Spinner */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <script>
        // Load Google Maps Script dynamically
        const loadGoogleMaps = () => {
            const existingScript =
                document.getElementById("google-maps-script");
            if (existingScript) return;

            const script = document.createElement("script");
            script.id = "google-maps-script";
            // Use environment variable for Google Maps API key
            const apiKey = "AIzaSyCPUa0e_IB0rB5UeJrWa3__Lohkm7HB9hY";
            if (!apiKey) {
                console.warn(
                    "Google Maps API key not configured. Address autocomplete disabled.",
                );
                return;
            }
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&loading=async&callback=initAutocomplete`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        };

        // Make initAutocomplete globally available
        (window as any).initAutocomplete = () => {
            const addressInput = document.getElementById(
                "address",
            ) as HTMLInputElement;
            if (!addressInput) return;

            const google = (window as any).google;
            if (!google) return;

            const autocomplete = new google.maps.places.Autocomplete(
                addressInput,
                {
                    types: ["address"],
                    componentRestrictions: { country: "us" }, // Restrict to US
                },
            );

            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    return;
                }

                // Extract address components for CRM
                const components = place.address_components || [];
                let streetNumber = "";
                let streetName = "";
                let city = "";
                let state = "";
                let zipCode = "";

                components.forEach((component: any) => {
                    const types = component.types;
                    if (types.includes("street_number")) {
                        streetNumber = component.long_name;
                    } else if (types.includes("route")) {
                        streetName = component.long_name;
                    } else if (types.includes("locality")) {
                        city = component.long_name;
                    } else if (types.includes("administrative_area_level_1")) {
                        state = component.short_name;
                    } else if (types.includes("postal_code")) {
                        zipCode = component.long_name;
                    }
                });

                // Fill hidden fields for CRM
                (
                    document.getElementById("streetNumber") as HTMLInputElement
                ).value = streetNumber;
                (
                    document.getElementById("streetName") as HTMLInputElement
                ).value = streetName;
                (document.getElementById("city") as HTMLInputElement).value =
                    city;
                (document.getElementById("state") as HTMLInputElement).value =
                    state;
                (document.getElementById("zipCode") as HTMLInputElement).value =
                    zipCode;

                // Show address fields when autocomplete is used
                const addressFieldsContainer = document.getElementById(
                    "addressFieldsContainer",
                );
                if (addressFieldsContainer) {
                    addressFieldsContainer.classList.remove("hidden");
                }
            });
        };

        // Load Google reCAPTCHA v3 Script dynamically
        const loadRecaptcha = () => {
            const existingScript = document.getElementById("recaptcha-script");
            if (existingScript) return;

            const script = document.createElement("script");
            script.id = "recaptcha-script";
            script.src =
                "https://www.google.com/recaptcha/api.js?render=6LeDDjUsAAAAAEJquohduwPouri3rOne3ahYp765";
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        };

        // Load scripts on mount - trigger on interaction for better performance
        let scriptsLoaded = false;
        const initScripts = () => {
            if (scriptsLoaded) return;
            loadGoogleMaps();
            loadRecaptcha();
            scriptsLoaded = true;
        };

        // Initialize on focus or touch
        ["focusin", "touchstart", "mouseover"].forEach((event) => {
            document
                .getElementById("bookingForm")
                ?.addEventListener(event, initScripts, { once: true });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById(
                "bookingForm",
            ) as HTMLFormElement;
            const steps = document.querySelectorAll(".form-step");
            const nextBtns = document.querySelectorAll(".next-step-btn");
            const prevBtns = document.querySelectorAll(".prev-step-btn");
            const submitBtn = form.querySelector('button[type="submit"]');

            // Conditional field displays
            const serviceType = document.getElementById(
                "serviceType",
            ) as HTMLSelectElement;
            const additionalDetailsContainer = document.getElementById(
                "additionalDetailsContainer",
            );
            const addressInput = document.getElementById(
                "address",
            ) as HTMLInputElement;
            const addressFieldsContainer = document.getElementById(
                "addressFieldsContainer",
            );

            // Show additional details only after service selection
            if (serviceType && additionalDetailsContainer) {
                serviceType.addEventListener("change", () => {
                    if (serviceType.value) {
                        additionalDetailsContainer.classList.remove("hidden");
                    }
                });
            }

            // Show address fields after address is entered
            if (addressInput && addressFieldsContainer) {
                // Check address completion
                const checkAddressComplete = () => {
                    if (addressInput.value.trim().length > 10) {
                        addressFieldsContainer.classList.remove("hidden");
                    }
                };

                // Check on blur (manual entry)
                addressInput.addEventListener("blur", checkAddressComplete);

                // Check on input (with debounce)
                let addressTimeout: ReturnType<typeof setTimeout>;
                addressInput.addEventListener("input", () => {
                    clearTimeout(addressTimeout);
                    addressTimeout = setTimeout(checkAddressComplete, 500);
                });
            }

            let currentStep = 1;

            function showStep(step: number) {
                steps.forEach((s) => {
                    if (s instanceof HTMLElement) {
                        const stepNum = parseInt(s.dataset.step || "0");
                        if (stepNum === step) {
                            s.classList.remove("hidden");
                            s.classList.add("active");
                        } else {
                            s.classList.add("hidden");
                            s.classList.remove("active");
                        }
                    }
                });
                currentStep = step;

                // Lazy load scripts based on step
                if (step === 2) {
                    loadGoogleMaps();
                } else if (step === 3) {
                    loadRecaptcha();
                }

                // Update progress indicator
                const progressIndicators =
                    document.querySelectorAll(".step-indicator");
                const stepLines = document.querySelectorAll(".step-line");

                progressIndicators.forEach((indicator) => {
                    if (indicator instanceof HTMLElement) {
                        const indicatorStep = parseInt(
                            indicator.dataset.step || "0",
                        );
                        indicator.classList.remove("active", "completed");

                        if (indicatorStep === step) {
                            indicator.classList.add("active");
                        } else if (indicatorStep < step) {
                            indicator.classList.add("completed");
                        }
                    }
                });

                // Update step lines
                stepLines.forEach((line, index) => {
                    if (index < step - 1) {
                        line.classList.add("completed");
                    } else {
                        line.classList.remove("completed");
                    }
                });
            }

            function validateStep(step: number): boolean {
                const currentStepEl = document.querySelector(
                    `.form-step[data-step="${step}"]`,
                );
                if (!currentStepEl) return false;

                const inputs = currentStepEl.querySelectorAll(
                    "input[required], select[required], textarea[required]",
                );
                let isValid = true;

                inputs.forEach((input) => {
                    if (
                        input instanceof HTMLInputElement ||
                        input instanceof HTMLSelectElement ||
                        input instanceof HTMLTextAreaElement
                    ) {
                        // Handle checkboxes (used in Step 3 for consent)
                        if (
                            input.type === "checkbox" &&
                            input instanceof HTMLInputElement
                        ) {
                            if (!input.checked) {
                                isValid = false;
                                // Visual feedback could be added here
                            }
                        }
                        // Handle all other input types
                        else if (!input.value.trim()) {
                            isValid = false;
                            input.classList.add("border-red-500");
                        } else {
                            input.classList.remove("border-red-500");
                        }

                        input.addEventListener("input", () => {
                            input.classList.remove("border-red-500");
                        });
                        input.addEventListener("change", () => {
                            input.classList.remove("border-red-500");
                        });
                    }
                });

                return isValid;
            }

            nextBtns.forEach((btn) => {
                btn.addEventListener("click", () => {
                    if (validateStep(currentStep)) {
                        showStep(currentStep + 1);
                    }
                });
            });

            prevBtns.forEach((btn) => {
                btn.addEventListener("click", () => {
                    showStep(currentStep - 1);
                });
            });

            // Form submission with reCAPTCHA v3
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                if (!validateStep(currentStep)) return;

                const successEl = document.getElementById("formSuccess");
                const errorEl = document.getElementById("formError");
                const errorMsg = document.getElementById("errorMessage");

                // Hide any previous messages
                if (errorEl) errorEl.classList.add("hidden");

                // Disable button and show loading
                if (submitBtn) {
                    (submitBtn as HTMLButtonElement).disabled = true;
                    (submitBtn as HTMLButtonElement).innerHTML = `
                    <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Sending...
                `;
                }

                try {
                    // Get reCAPTCHA v3 token
                    const grecaptcha = (window as any).grecaptcha;
                    let recaptchaVerified = false;
                    if (grecaptcha) {
                        try {
                            // Ensure grecaptcha is ready
                            if (typeof grecaptcha.ready === "function") {
                                await new Promise((resolve) =>
                                    grecaptcha.ready(resolve),
                                );
                                const token = await grecaptcha.execute(
                                    "6LeDDjUsAAAAAEJquohduwPouri3rOne3ahYp765",
                                    { action: "submit" },
                                );

                                // Add token to form
                                const tokenInput =
                                    document.createElement("input");
                                tokenInput.type = "hidden";
                                tokenInput.name = "g-recaptcha-response";
                                tokenInput.value = token;
                                form.appendChild(tokenInput);
                                recaptchaVerified = true;
                            }
                        } catch (err) {
                            console.error("reCAPTCHA error:", err);
                        }
                    }

                    // Collect analytics tracking data
                    const trackingData = {
                        // Session & timing
                        sessionStart:
                            sessionStorage.getItem("sessionStart") ||
                            new Date().toISOString(),
                        timeOnSite: Math.round(
                            (Date.now() -
                                parseInt(
                                    sessionStorage.getItem("sessionStart") ||
                                        Date.now().toString(),
                                )) /
                                1000,
                        ),

                        // Navigation
                        currentUrl: window.location.href,
                        referrer: document.referrer || "Direct",
                        clickPath:
                            sessionStorage.getItem("clickPath") ||
                            window.location.pathname,

                        // Device & browser
                        userAgent: navigator.userAgent,
                        deviceType: /Mobile|Android|iPhone/i.test(
                            navigator.userAgent,
                        )
                            ? "Mobile"
                            : "Desktop",
                        screenResolution: `${screen.width}x${screen.height}`,
                        language: navigator.language,

                        // Consent & cookies
                        cookiesAccepted:
                            localStorage.getItem("cookie-consent") ===
                            "accepted",
                        consentTimestamp:
                            localStorage.getItem("cookie-consent-timestamp") ||
                            "N/A",
                        recaptchaVerified,

                        // Traffic source
                        utmSource:
                            new URLSearchParams(window.location.search).get(
                                "utm_source",
                            ) ||
                            sessionStorage.getItem("utm_source") ||
                            "N/A",
                        utmMedium:
                            new URLSearchParams(window.location.search).get(
                                "utm_medium",
                            ) ||
                            sessionStorage.getItem("utm_medium") ||
                            "N/A",
                        utmCampaign:
                            new URLSearchParams(window.location.search).get(
                                "utm_campaign",
                            ) ||
                            sessionStorage.getItem("utm_campaign") ||
                            "N/A",
                        gclid:
                            new URLSearchParams(window.location.search).get(
                                "gclid",
                            ) ||
                            sessionStorage.getItem("gclid") ||
                            null,
                        trafficSource:
                            new URLSearchParams(window.location.search).get(
                                "gclid",
                            ) || sessionStorage.getItem("gclid")
                                ? "Google Ads"
                                : document.referrer.includes("google.com")
                                  ? "Google Organic"
                                  : document.referrer.includes("facebook.com")
                                    ? "Facebook"
                                    : document.referrer
                                      ? "Referral"
                                      : "Direct",

                        // New vs Returning visitor detection
                        newReturning: (() => {
                            const lastVisit =
                                localStorage.getItem("lastVisitTimestamp");
                            const isReturning = lastVisit !== null;
                            // Update last visit timestamp
                            localStorage.setItem(
                                "lastVisitTimestamp",
                                new Date().toISOString(),
                            );
                            return isReturning ? "Returning" : "New";
                        })(),
                    };

                    // Add tracking data as hidden fields
                    Object.keys(trackingData).forEach((key) => {
                        const input = document.createElement("input");
                        input.type = "hidden";
                        input.name = `tracking_${key}`;
                        input.value =
                            (trackingData as any)[key]?.toString() || "N/A";
                        form.appendChild(input);
                    });

                    const formData = new FormData(form);

                    // Submit to PHP backend (SMTP2GO integration)
                    const response = await fetch("/api/send-email.php", {
                        method: "POST",
                        body: formData,
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Push conversion event to GTM dataLayer
                        if (
                            typeof window !== "undefined" &&
                            (window as any).dataLayer
                        ) {
                            (window as any).dataLayer.push({
                                event: "form_submission",
                                form_type: "booking_form",
                                service_type: formData.get("serviceType"),
                                urgency: formData.get("urgency"),
                                city: formData.get("city") || "Unknown",
                            });
                        }

                        // Set flag for thank-you page validation
                        sessionStorage.setItem("formSubmitted", "true");
                        // Redirect to thank-you page for lead tracking
                        window.location.href = "/thank-you";
                    } else {
                        // Show error message
                        if (errorEl && errorMsg) {
                            errorMsg.textContent =
                                result.message ||
                                "Something went wrong. Please try again.";
                            errorEl.classList.remove("hidden");
                        }
                    }
                } catch (err) {
                    if (errorEl && errorMsg) {
                        errorMsg.textContent =
                            "Network error. Please check your connection and try again.";
                        errorEl.classList.remove("hidden");
                    }
                } finally {
                    if (submitBtn) {
                        (submitBtn as HTMLButtonElement).disabled = false;
                        (submitBtn as HTMLButtonElement).innerText =
                            "Submit Request";
                    }
                }
            });

            // Reset form button handler
            const resetBtn = document.querySelector(".reset-form-btn");
            if (resetBtn) {
                resetBtn.addEventListener("click", () => {
                    const successEl = document.getElementById("formSuccess");
                    if (successEl) successEl.classList.add("hidden");
                    form.classList.remove("hidden");
                    showStep(1);
                });
            }
        });
    </script>
</div>
