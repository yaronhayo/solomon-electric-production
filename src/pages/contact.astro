---
import Layout from "../layouts/Layout.astro";
import heroImage from "../assets/images/heroes/contact.png";
import Button from "../components/ui/Button.astro";
import CtaButton from "../components/ui/CtaButton.astro";
import Container from "../components/ui/Container.astro";
import PageHero from "../components/PageHero.astro";
import { SITE_CONFIG } from "../config/site";
import Breadcrumb from "../components/Breadcrumb.astro";
import { generateBreadcrumbSchema } from "../utils/seo";
import { Phone, Mail, MapPin, Clock, AlertTriangle } from "lucide-astro";

// Generate ContactPage Schema
const contactSchema = {
    "@context": "https://schema.org",
    "@type": "ContactPage",
    mainEntity: {
        "@type": "ElectricalContractor",
        "@id": `${SITE_CONFIG.seo.siteUrl}/#organization`,
        telephone: SITE_CONFIG.contact.phone.formatted,
        email: SITE_CONFIG.contact.email.primary,
        address: {
            "@type": "PostalAddress",
            streetAddress: SITE_CONFIG.contact.address.street,
            addressLocality: SITE_CONFIG.contact.address.city,
            addressRegion: SITE_CONFIG.contact.address.state,
            postalCode: SITE_CONFIG.contact.address.zip,
            addressCountry: "US",
        },
        openingHoursSpecification: [
            {
                "@type": "OpeningHoursSpecification",
                dayOfWeek: [
                    "Monday",
                    "Tuesday",
                    "Wednesday",
                    "Thursday",
                    "Friday",
                    "Saturday",
                    "Sunday",
                ],
                opens: "00:00",
                closes: "23:59",
            },
        ],
        contactPoint: [
            {
                "@type": "ContactPoint",
                telephone: SITE_CONFIG.contact.phone.formatted,
                contactType: "customer service",
                availableLanguage: ["English", "Spanish"],
                areaServed: {
                    "@type": "State",
                    name: "Florida",
                },
            },
            {
                "@type": "ContactPoint",
                telephone: SITE_CONFIG.contact.phone.formatted,
                contactType: "emergency",
                hoursAvailable: {
                    "@type": "OpeningHoursSpecification",
                    dayOfWeek: [
                        "Monday",
                        "Tuesday",
                        "Wednesday",
                        "Thursday",
                        "Friday",
                        "Saturday",
                        "Sunday",
                    ],
                    opens: "00:00",
                    closes: "23:59",
                },
            },
        ],
    },
};

const breadcrumbSchema = generateBreadcrumbSchema(
    [
        { name: "Home", url: "/" },
        { name: "Contact", url: "/contact" },
    ],
    SITE_CONFIG.seo.siteUrl,
);
---

<Layout
    title="Contact Solomon Electric | 24/7 Miami Electrician | (786) 833-9211"
    description="Need an electrician? Call (786) 833-9211 for 24/7 emergency service in Miami-Dade & Broward. Free estimates, same-day appointments. Licensed & insured."
    ogImage={`${SITE_CONFIG.seo.siteUrl}/og-default.jpg`}
    ogImageAlt="Contact Solomon Electric - 24/7 Emergency Electrical Service in Miami"
    topBarDark={true}
>
    <!-- ContactPage Schema Markup -->
    <script
        type="application/ld+json"
        set:html={JSON.stringify(contactSchema)}
    />
    <script
        type="application/ld+json"
        set:html={JSON.stringify(breadcrumbSchema)}
    />

    <!-- Breadcrumb Navigation -->
    <Breadcrumb items={[{ label: "Home", href: "/" }, { label: "Contact" }]} />

    <!-- Hero Section -->
    <PageHero
        title="Call Miami's Top Electrician<br/><span class='text-transparent bg-clip-text bg-gradient-to-r from-accent to-white'>(786) 833-9211 • 24/7 Service</span>"
        subtitle="Licensed #EC13012419 • Free Estimates • Same-Day Available"
        description="Emergency electrical repair? Panel upgrade questions? EV charger installation quote? Contact Solomon Electric anytime—we answer calls 24/7 and provide free estimates for all electrical services in Miami-Dade and Broward counties."
        image={heroImage}
        trustIndicators={true}
    />

    <div class="bg-light py-20 md:py-32">
        <Container>
            <div
                class="grid grid-cols-1 lg:grid-cols-2 items-start"
                style="gap: var(--spacing-3xl);"
            >
                <!-- Contact Info -->
                <div>
                    <h2
                        class="text-4xl md:text-5xl font-black text-primary leading-tight uppercase"
                        style="margin-bottom: var(--spacing-xl);"
                    >
                        Miami Electrician <span class="text-accent"
                            >Contact Info</span
                        >
                    </h2>

                    <div class="space-y-10">
                        <div
                            class="flex items-start gap-6 group glass-bg glass-border p-6 rounded-2xl transition-all hover:bg-white/10"
                        >
                            <div
                                class="bg-accent/10 p-5 rounded-xl text-accent border border-accent/20 group-hover:bg-accent group-hover:text-white transition-all duration-300 shimmer-authority"
                            >
                                <Phone class="w-8 h-8" />
                            </div>
                            <div>
                                <h3
                                    class="text-xl font-bold mb-1 text-primary uppercase tracking-wide font-secondary"
                                >
                                    Phone
                                </h3>
                                <p class="text-body mb-2 font-medium">
                                    24/7 Emergency Service
                                </p>
                                <a
                                    href={SITE_CONFIG.contact.phone.href}
                                    class="text-2xl font-black text-accent hover:text-primary transition-colors tracking-wider"
                                    >{SITE_CONFIG.contact.phone.formatted}</a
                                >
                            </div>
                        </div>

                        <div
                            class="flex items-start gap-6 group glass-bg glass-border p-6 rounded-2xl transition-all hover:bg-white/10"
                        >
                            <div
                                class="bg-accent/10 p-5 rounded-xl text-accent border border-accent/20 group-hover:bg-accent group-hover:text-white transition-all duration-300"
                            >
                                <Mail class="w-8 h-8" />
                            </div>
                            <div>
                                <h3
                                    class="text-xl font-bold mb-1 text-primary uppercase tracking-wide font-secondary"
                                >
                                    Email
                                </h3>
                                <p class="text-body mb-2 font-medium">
                                    For general inquiries & quotes
                                </p>
                                <a
                                    href={`mailto:${SITE_CONFIG.contact.email.primary}`}
                                    class="text-xl font-bold text-primary hover:text-accent transition-colors"
                                    >{SITE_CONFIG.contact.email.primary}</a
                                >
                            </div>
                        </div>

                        <div
                            class="flex items-start gap-6 group glass-bg glass-border p-6 rounded-2xl transition-all hover:bg-white/10"
                        >
                            <div
                                class="bg-accent/10 p-5 rounded-xl text-accent border border-accent/20 group-hover:bg-accent group-hover:text-white transition-all duration-300"
                            >
                                <MapPin class="w-8 h-8" />
                            </div>
                            <div>
                                <h3
                                    class="text-xl font-bold mb-1 text-primary uppercase tracking-wide font-secondary"
                                >
                                    Service Areas
                                </h3>
                                <p class="text-body font-medium">
                                    Miami-Dade, Broward &<br />Palm Beach
                                    Counties
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Form -->
                <div
                    class="glass-bg-dark p-8 md:p-10 border-l-4 border-l-accent shadow-xl relative overflow-hidden rounded-2xl"
                >
                    <!-- Decorative Corner Element -->
                    <div
                        class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-accent/10 to-transparent pointer-events-none"
                    >
                    </div>
                    <h2
                        class="text-3xl font-black mb-8 text-primary uppercase relative z-10"
                    >
                        Send a <span class="text-accent">Message</span>
                    </h2>
                    <form id="contact-form" class="space-y-6">
                        <div>
                            <label
                                for="name"
                                class="block text-sm font-bold text-[var(--text-muted)] mb-3 uppercase tracking-wide font-secondary"
                                >Your Name</label
                            >
                            <input
                                type="text"
                                id="name"
                                name="name"
                                required
                                class="w-full bg-light border-2 border-gray-200 px-6 py-4 text-primary focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all placeholder-gray-400 font-medium"
                                placeholder="John Doe"
                            />
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label
                                    for="email"
                                    class="block text-sm font-bold text-[var(--text-muted)] mb-3 uppercase tracking-wide font-secondary"
                                    >Email Address</label
                                >
                                <input
                                    type="email"
                                    id="email"
                                    name="email"
                                    required
                                    class="w-full bg-light border-2 border-gray-200 px-6 py-4 text-primary focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all placeholder-gray-400 font-medium"
                                    placeholder="john@example.com"
                                />
                            </div>
                            <div>
                                <label
                                    for="phone"
                                    class="block text-sm font-bold text-[var(--text-muted)] mb-3 uppercase tracking-wide font-secondary"
                                    >Phone Number</label
                                >
                                <input
                                    type="tel"
                                    id="phone"
                                    name="phone"
                                    required
                                    class="w-full bg-light border-2 border-gray-200 px-6 py-4 text-primary focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all placeholder-gray-400 font-medium"
                                    placeholder="(305) 555-0123"
                                />
                            </div>
                        </div>

                        <div>
                            <label
                                for="message"
                                class="block text-sm font-bold text-[var(--text-muted)] mb-3 uppercase tracking-wide font-secondary"
                                >Message</label
                            >
                            <textarea
                                id="message"
                                name="message"
                                rows="4"
                                required
                                class="w-full bg-light border-2 border-gray-200 px-6 py-4 text-primary focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all placeholder-gray-400 font-medium resize-none"
                                placeholder="How can we help you?"></textarea>
                        </div>

                        <button
                            type="submit"
                            id="submit-btn"
                            class="w-full bg-accent text-white font-black text-lg py-5 hover:bg-primary transition-all transform hover:-translate-y-1 uppercase tracking-widest shadow-[var(--shadow-lg)] border-l-4 border-primary"
                        >
                            Send Message
                        </button>

                        <div
                            id="form-status"
                            class="hidden text-center p-4 rounded-lg font-bold mt-4"
                        >
                        </div>
                    </form>
                </div>
            </div>
        </Container>
    </div>

    <!-- Business Hours & Emergency Protocol -->
    <section
        id="business-hours"
        aria-labelledby="hours-heading"
        class="bg-light py-20 md:py-32"
    >
        <Container>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                <!-- Business Hours -->
                <div
                    class="bg-[var(--bg-surface)] p-8 rounded-[var(--radius-xl)] border border-[var(--border-light)]"
                >
                    <div class="flex items-center gap-4 mb-6">
                        <div
                            class="w-12 h-12 bg-accent rounded-full flex items-center justify-center"
                        >
                            <Clock class="w-6 h-6 text-white" />
                        </div>
                        <h2
                            id="hours-heading"
                            class="text-2xl font-black text-primary uppercase"
                        >
                            Business Hours
                        </h2>
                    </div>
                    <div class="space-y-3">
                        <div
                            class="flex justify-between items-center py-2 border-b border-gray-200"
                        >
                            <span class="text-gray-700 font-bold"
                                >Monday - Friday</span
                            >
                            <span class="text-primary font-black">24 Hours</span
                            >
                        </div>
                        <div
                            class="flex justify-between items-center py-2 border-b border-gray-200"
                        >
                            <span class="text-gray-700 font-bold">Saturday</span
                            >
                            <span class="text-primary font-black">24 Hours</span
                            >
                        </div>
                        <div
                            class="flex justify-between items-center py-2 border-b border-gray-200"
                        >
                            <span class="text-gray-700 font-bold">Sunday</span>
                            <span class="text-primary font-black">24 Hours</span
                            >
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span
                                class="text-accent font-black uppercase tracking-wide"
                                >Emergency Service</span
                            >
                            <span class="text-accent font-black">24/7</span>
                        </div>
                    </div>
                </div>

                <!-- Emergency Protocol -->
                <div
                    class="bg-gradient-to-br from-accent/10 to-accent/5 p-8 rounded-2xl border border-accent/20"
                >
                    <div class="flex items-center gap-4 mb-6">
                        <div
                            class="w-12 h-12 bg-accent rounded-full flex items-center justify-center animate-pulse"
                        >
                            <AlertTriangle class="w-6 h-6 text-white" />
                        </div>
                        <h2 class="text-2xl font-black text-primary uppercase">
                            Emergency Protocol
                        </h2>
                    </div>
                    <div class="space-y-4">
                        <p class="text-gray-700 font-medium leading-relaxed">
                            <span class="font-black text-accent"
                                >Electrical emergencies require immediate
                                attention.</span
                            > If you're experiencing any of the following, call us
                            now:
                        </p>
                        <ul class="space-y-2 text-gray-700 font-medium">
                            <li class="flex items-start gap-3">
                                <span class="text-accent font-black mt-1"
                                    >•</span
                                >
                                <span>Sparking outlets or electrical panel</span
                                >
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-accent font-black mt-1"
                                    >•</span
                                >
                                <span>Burning smell from outlets or wiring</span
                                >
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-accent font-black mt-1"
                                    >•</span
                                >
                                <span>Complete power outage</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-accent font-black mt-1"
                                    >•</span
                                >
                                <span>Exposed or damaged wiring</span>
                            </li>
                        </ul>
                        <p
                            class="text-sm text-[var(--text-body)] font-medium italic pt-4 border-t border-accent/20"
                        >
                            <span class="font-bold text-primary"
                                >24/7 Availability:</span
                            > Our dispatch team is staffed around the clock. Licensed
                            electricians serve all of Miami-Dade and Broward County.
                        </p>
                    </div>
                </div>
            </div>
        </Container>
    </section>

    <script>
        // Load Google reCAPTCHA v3 Script dynamically
        const loadRecaptcha = () => {
            if (document.getElementById("recaptcha-script")) return;
            const script = document.createElement("script");
            script.id = "recaptcha-script";
            script.src =
                "https://www.google.com/recaptcha/api.js?render=6LeDDjUsAAAAAEJquohduwPouri3rOne3ahYp765";
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        };

        // Initialize on interaction
        ["focusin", "touchstart", "mouseover"].forEach((event) => {
            document
                .getElementById("contact-form")
                ?.addEventListener(event, loadRecaptcha, { once: true });
        });

        const form = document.getElementById("contact-form") as HTMLFormElement;
        const statusDiv = document.getElementById("form-status");
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!statusDiv || !submitBtn) return;

            // Loading state
            submitBtn.disabled = true;
            submitBtn.textContent = "Sending...";
            statusDiv.classList.add("hidden");
            statusDiv.className =
                "hidden text-center p-4 rounded-lg font-bold mt-4";

            try {
                // reCAPTCHA verification
                let recaptchaVerified = false;
                let recaptchaToken = "";
                const grecaptcha = (window as any).grecaptcha;

                if (grecaptcha) {
                    await new Promise((resolve) => grecaptcha.ready(resolve));
                    recaptchaToken = await grecaptcha.execute(
                        "6LeDDjUsAAAAAEJquohduwPouri3rOne3ahYp765",
                        { action: "submit" },
                    );
                    recaptchaVerified = true;
                }

                // Collect tracking data
                const trackingData = {
                    sessionStart:
                        sessionStorage.getItem("sessionStart") ||
                        new Date().toISOString(),
                    timeOnSite: Math.round(
                        (Date.now() -
                            parseInt(
                                sessionStorage.getItem("sessionStart") ||
                                    Date.now().toString(),
                            )) /
                            1000,
                    ),
                    currentUrl: window.location.href,
                    referrer: document.referrer || "Direct",
                    clickPath:
                        sessionStorage.getItem("clickPath") ||
                        window.location.pathname,
                    deviceType: /Mobile|Android|iPhone/i.test(
                        navigator.userAgent,
                    )
                        ? "Mobile"
                        : "Desktop",
                    cookiesAccepted:
                        localStorage.getItem("cookie-consent") === "accepted",
                    consentTimestamp:
                        localStorage.getItem("cookie-consent-timestamp") ||
                        "N/A",
                    recaptchaVerified,
                    utmSource:
                        new URLSearchParams(window.location.search).get(
                            "utm_source",
                        ) ||
                        sessionStorage.getItem("utm_source") ||
                        "N/A",
                    utmMedium:
                        new URLSearchParams(window.location.search).get(
                            "utm_medium",
                        ) ||
                        sessionStorage.getItem("utm_medium") ||
                        "N/A",
                    utmCampaign:
                        new URLSearchParams(window.location.search).get(
                            "utm_campaign",
                        ) ||
                        sessionStorage.getItem("utm_campaign") ||
                        "N/A",
                    gclid:
                        new URLSearchParams(window.location.search).get(
                            "gclid",
                        ) ||
                        sessionStorage.getItem("gclid") ||
                        null,
                    trafficSource:
                        new URLSearchParams(window.location.search).get(
                            "gclid",
                        ) || sessionStorage.getItem("gclid")
                            ? "Google Ads"
                            : document.referrer.includes("google.com")
                              ? "Google Organic"
                              : "Direct",
                };

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                // Merge data
                const payload = {
                    ...data,
                    "g-recaptcha-response": recaptchaToken,
                };

                // Add tracking data with prefix
                Object.keys(trackingData).forEach((key) => {
                    (payload as any)[`tracking_${key}`] = (trackingData as any)[
                        key
                    ];
                });

                const response = await fetch("/api/contact.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                const result = await response.json();

                if (response.ok && result.status === "success") {
                    if (
                        typeof window !== "undefined" &&
                        (window as any).dataLayer
                    ) {
                        (window as any).dataLayer.push({
                            event: "form_submission",
                            form_type: "contact_form",
                        });
                    }
                    sessionStorage.setItem("formSubmitted", "true");
                    window.location.href = "/thank-you";
                } else {
                    throw new Error(result.message || "Failed to send message");
                }
            } catch (error) {
                statusDiv.classList.remove("hidden");
                statusDiv.classList.add(
                    "bg-red-500/10",
                    "text-red-600",
                    "border",
                    "border-red-500/20",
                );
                statusDiv.textContent =
                    error instanceof Error
                        ? error.message
                        : "Something went wrong. Please try again.";
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Send Message";
            }
        });
    </script>
</Layout>
