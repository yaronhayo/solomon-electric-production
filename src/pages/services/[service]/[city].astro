---
/**
 * Service + Location Dynamic Page
 * Generates hyper-local landing pages for every service in every city
 * URL Pattern: /services/{service-slug}/{city-slug}
 * Example: /services/electrical-panel-upgrade-100a-to-200a/miami
 */

import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import Layout from "../../../layouts/Layout.astro";
import Container from "../../../components/ui/Container.astro";
import Button from "../../../components/ui/Button.astro";
import CtaButton from "../../../components/ui/CtaButton.astro";
import ReviewCarousel from "../../../components/ReviewCarousel.astro";
import Breadcrumb from "../../../components/Breadcrumb.astro";
import { SITE_CONFIG } from "../../../config/site";
import {
    generateIntro,
    generateWhyChoose,
    generateMetaTitle,
    generateMetaDescription,
    generateServiceLocationSchema,
    generateLocalRegulatoryInfo,
    getRelatedCities,
} from "../../../utils/service-location-generator";
import { replacePlaceholder } from "../../../utils/content";

import {
    Zap,
    MapPin,
    CheckCircle,
    Shield,
    Clock,
    Star,
    Home,
    Umbrella,
    ArrowRight,
    ChevronRight,
} from "lucide-astro";

export const prerender = true;

export async function getStaticPaths() {
    const services = await getCollection("services");
    const serviceAreas = await getCollection("service-areas");

    const paths = [];

    for (const service of services) {
        for (const city of serviceAreas) {
            paths.push({
                params: {
                    service: service.id,
                    city: city.id,
                },
                props: {
                    service: service.data,
                    serviceId: service.id,
                    city: city.data,
                    cityId: city.id,
                    allCities: serviceAreas.map((c) => ({
                        slug: c.id,
                        name: c.data.name,
                        county: c.data.county,
                    })),
                    allServices: services.map((s) => ({
                        slug: s.id,
                        name: s.data.name,
                        category: s.data.category,
                    })),
                },
            });
        }
    }

    return paths;
}

const { service, serviceId, city, cityId, allCities, allServices } =
    Astro.props;

// Generate content
const metaTitle = generateMetaTitle(service.name, city.name);
const metaDescription = generateMetaDescription(
    service.name,
    city.name,
    city.neighborhoods || [],
);
const introText = replacePlaceholder(generateIntro(
    service.name,
    city.name,
    city.county,
    city.neighborhoods || [],
));
const whyChooseText = replacePlaceholder(generateWhyChoose(
    service.name,
    city.name,
    cityId,
    city.county,
));

// Get related cities for this service
// Get related cities for this service (All 27 for maximum internal linking)
const relatedCities = getRelatedCities(cityId, allCities, 27);

// Get related services in this city (same category first)
const relatedServices = allServices
    .filter((s) => s.slug !== serviceId)
    .sort((a, b) => {
        if (a.category === service.category && b.category !== service.category)
            return -1;
        if (b.category === service.category && a.category !== service.category)
            return 1;
        return 0;
    })
    .slice(0, 6);

// Combine FAQs from service with city context
const combinedFaqs = (service.faqs || []).map(
    (faq: { question: string; answer: string }) => ({
        question: faq.question
            .replace(/Miami/g, city.name)
            .replace(
                /South Florida/g,
                `${city.name} and ${city.county} County`,
            ),
        answer: faq.answer
            .replace(/Miami/g, city.name)
            .replace(/Miami-Dade/g, city.county),
    }),
);

// Add city-specific FAQ
if (city.faqs && city.faqs.length > 0) {
    // Try to find FAQs that match the service category
    const relevantCityFaqs = city.faqs.filter(
        (faq: any) =>
            faq.question
                .toLowerCase()
                .includes(service.category.toLowerCase()) ||
            faq.answer.toLowerCase().includes(service.category.toLowerCase()),
    );

    if (relevantCityFaqs.length > 0) {
        combinedFaqs.unshift(...relevantCityFaqs.slice(0, 2));
    } else {
        combinedFaqs.push(...city.faqs.slice(0, 2));
    }
}

// Generate schema with FAQs for rich snippets
const schema = generateServiceLocationSchema(
    {
        name: service.name,
        slug: serviceId,
        description: service.description,
        category: service.category,
    },
    {
        name: city.name,
        slug: cityId,
        county: city.county,
        coordinates: city.coordinates,
    },
    combinedFaqs, // Include FAQs for FAQPage schema
);

// Generate local regulatory info
const regulatoryInfo = generateLocalRegulatoryInfo(city.county);
---

<Layout 
    title={metaTitle} 
    description={metaDescription}
    ogImage={service.image ? (typeof service.image === 'string' ? service.image : service.image.src) : "/og-default.jpg"}
    ogImageAlt={service.imageAlt || `${service.name} in ${city.name}`}
>
    <!-- Schema Markup -->
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />

    <!-- Breadcrumb -->
    <Breadcrumb
        items={[
            { label: "Home", href: "/" },
            { label: "Services", href: "/services" },
            { label: service.name, href: `/services/${serviceId}` },
            { label: city.name },
        ]}
    />

    <!-- Hero Section -->
    <section
        class="relative bg-gradient-to-br from-primary via-primary to-primary/95 overflow-hidden"
        style="padding-top: var(--spacing-3xl); padding-bottom: var(--spacing-3xl);"
    >
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-10">
            <div
                class="absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,_var(--color-accent)_0%,_transparent_50%)]"
            >
            </div>
            <div
                class="absolute inset-0 bg-[radial-gradient(circle_at_70%_80%,_var(--color-accent)_0%,_transparent_40%)]"
            >
            </div>
        </div>

        <Container class="relative z-10 w-full">
                <!-- Right Column: Image - spans 4 columns -->
                <div class="hidden lg:block lg:col-span-4 relative">
                    <div class="absolute -inset-4 bg-accent/20 blur-3xl rounded-full"></div>
                    <div class="relative glass-card overflow-hidden rounded-2xl border border-white/10 shadow-2xl transform hover:scale-[1.02] transition-transform duration-500">
                        {service.image && (
                            <Image 
                                src={service.image} 
                                alt={service.imageAlt || `${service.name} service in ${city.name}`}
                                class="w-full h-auto object-cover"
                                loading="eager"
                                fetchpriority="high"
                            />
                        )}
                        {!service.image && (
                            <div class="aspect-[4/5] bg-primary/40 flex items-center justify-center p-8 text-center">
                                <Zap class="w-20 h-20 text-accent/20 absolute opacity-20" />
                                <div class="relative z-10">
                                    <div class="w-16 h-16 bg-accent/20 rounded-2xl flex items-center justify-center mb-4 mx-auto">
                                        <Zap class="w-8 h-8 text-accent" />
                                    </div>
                                    <p class="text-white font-bold uppercase tracking-widest text-sm">
                                        Solomon Electric
                                    </p>
                                    <p class="text-accent text-xs mt-1">
                                        Licensed & Insured
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <!-- Floating Badge -->
                    <div class="absolute -bottom-6 -left-6 bg-white p-4 rounded-xl shadow-xl border border-gray-100 hidden xl:flex items-center gap-3">
                        <div class="w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center">
                            <Star class="w-6 h-6 text-accent fill-accent" />
                        </div>
                        <div>
                            <p class="text-primary font-black leading-none">{SITE_CONFIG.stats.averageRating} RATING</p>
                            <p class="text-[10px] text-primary/60 font-bold uppercase tracking-wider">{SITE_CONFIG.stats.totalReviews} LOCAL REVIEWS</p>
                        </div>
                    </div>
                </div>
            </div>
        </Container>
    </section>

    <!-- Why Choose Us Section -->
    <section
        class="bg-white"
        style="padding-top: var(--spacing-3xl); padding-bottom: var(--spacing-2xl);"
    >
        <Container>
            <div class="grid lg:grid-cols-2 gap-12 items-center">
                <div>
                    <span
                        class="text-accent font-bold uppercase tracking-widest text-sm mb-4 block"
                    >
                        Local Expertise
                    </span>
                    <h2
                        class="text-3xl md:text-4xl font-black text-primary uppercase mb-6"
                    >
                        Why {city.name} Chooses
                        <span class="text-accent"> Solomon Electric</span>
                    </h2>
                    <p
                        class="text-[var(--text-body)] text-lg leading-relaxed mb-6"
                    >
                        {whyChooseText}
                    </p>

                    <!-- Features List -->
                    <ul class="space-y-4">
                        {
                            (service.features || [])
                                .slice(0, 5)
                                .map((feature: string) => (
                                    <li class="flex items-start gap-3">
                                        <CheckCircle class="w-5 h-5 text-accent flex-shrink-0 mt-1" />
                                        <span class="text-[var(--text-body)] font-medium">
                                            {feature}
                                        </span>
                                    </li>
                                ))
                        }
                    </ul>
                </div>

                <!-- Stats Card -->
                <div
                    class="bg-gradient-to-br from-primary to-primary/90 rounded-2xl p-8 md:p-10 text-white"
                >
                    <h3 class="text-2xl font-black uppercase mb-8 text-center">
                        Our {city.name} Track Record
                    </h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="text-center">
                            <div class="text-4xl font-black text-accent mb-2">
                                {SITE_CONFIG.stats.averageRating}
                            </div>
                            <div
                                class="text-sm text-white/70 uppercase tracking-wide"
                            >
                                Star Rating
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-black text-accent mb-2">
                                {SITE_CONFIG.stats.totalReviews}
                            </div>
                            <div
                                class="text-sm text-white/70 uppercase tracking-wide"
                            >
                                Reviews
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-black text-accent mb-2">
                                24/7
                            </div>
                            <div
                                class="text-sm text-white/70 uppercase tracking-wide"
                            >
                                Emergency Service
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-black text-accent mb-2">
                                {SITE_CONFIG.credentials.yearsExperience}
                            </div>
                            <div
                                class="text-sm text-white/70 uppercase tracking-wide"
                            >
                                Years Experience
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t border-white/20 text-center">
                        <p class="text-sm text-white/70 mb-4">
                            Florida License #{
                                SITE_CONFIG.credentials.license.number
                            }
                        </p>
                        <CtaButton
                            action="call"
                            variant="secondary"
                            size="md"
                            text="Call Local Electrician"
                        />
                    </div>
                </div>
            </div>
        </Container>
    </section>

    <!-- Local Challenges & Solutions -->
    {
        city.challenges && city.challenges.length > 0 && (
            <section
                class="bg-light border-b border-gray-100"
                style="padding-top: var(--spacing-2xl); padding-bottom: var(--spacing-2xl);"
            >
                <Container>
                    <div class="mb-12">
                        <span class="text-accent font-bold uppercase tracking-widest text-sm mb-4 block">
                            Specific Local Solutions
                        </span>
                        <h2 class="text-3xl md:text-4xl font-black text-primary uppercase mb-6">
                            Addressing {city.name}'s Unique
                            <span class="text-accent">
                                {" "}
                                Electrical Challenges
                            </span>
                        </h2>
                        <p class="text-[var(--text-body)] text-lg">
                            South Florida's environment demands specialized
                            electrical knowledge. Our {service.name} solutions
                            in {city.name} are engineered to handle these local
                            factors effectively.
                        </p>
                    </div>

                    <div class="grid md:grid-cols-3 gap-8">
                        {city.challenges.map((challenge: any) => (
                            <div class="bg-white p-8 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-all">
                                <div class="w-12 h-12 bg-primary text-white rounded-xl flex items-center justify-center mb-6">
                                    {challenge.icon === "Zap" && (
                                        <Zap class="w-6 h-6 text-accent" />
                                    )}
                                    {challenge.icon === "Umbrella" && (
                                        <Umbrella class="w-6 h-6 text-accent" />
                                    )}
                                    {challenge.icon === "Home" && (
                                        <Home class="w-6 h-6 text-accent" />
                                    )}
                                    {!["Zap", "Umbrella", "Home"].includes(
                                        challenge.icon,
                                    ) && <Zap class="w-6 h-6 text-accent" />}
                                </div>
                                <h3 class="text-xl font-bold text-primary mb-4 uppercase">
                                    {challenge.title}
                                </h3>
                                <p class="text-[var(--text-body)] text-sm leading-relaxed">
                                    {challenge.description}
                                </p>
                            </div>
                        ))}
                    </div>
                </Container>
            </section>
        )
    }

    <!-- Compliance & Regulatory -->
    <section
        class="bg-white"
        style="padding-top: var(--spacing-xl); padding-bottom: var(--spacing-xl);"
    >
        <Container>
            <div
                class="bg-primary/5 rounded-2xl p-6 md:p-8 flex flex-col md:flex-row items-center gap-6 border border-primary/10"
            >
                <div
                    class="w-16 h-16 bg-primary text-white rounded-full flex items-center justify-center flex-shrink-0"
                >
                    <Shield class="w-8 h-8" />
                </div>
                <div class="flex-grow text-center md:text-left">
                    <h3 class="text-xl font-bold text-primary mb-2 uppercase">
                        {regulatoryInfo.title}
                    </h3>
                    <p class="text-[var(--text-body)] text-sm leading-relaxed">
                        {regulatoryInfo.content} We maintain full compliance with
                        <strong class="text-primary"
                            >{regulatoryInfo.jurisdiction}</strong
                        > standards for every {service.name} project.
                    </p>
                </div>
                <div class="flex-shrink-0">
                    <div
                        class="text-xs font-bold text-primary/60 uppercase tracking-widest mb-1 text-center md:text-right"
                    >
                        Permit Coordination
                    </div>
                    <div
                        class="text-sm font-black text-primary text-center md:text-right"
                    >
                        100% HANDLED BY US
                    </div>
                </div>
            </div>
        </Container>
    </section>

    <!-- Competitive Edge Section -->
    <section
        class="bg-light border-y border-gray-100"
        style="padding-top: var(--spacing-2xl); padding-bottom: var(--spacing-2xl);"
    >
        <Container>
            <div class="text-center mb-12">
                <span
                    class="text-accent font-bold uppercase tracking-widest text-sm mb-4 block"
                >
                    The Solomon Advantage
                </span>
                <h2
                    class="text-3xl md:text-4xl font-black text-primary uppercase"
                >
                    Our {city.name}
                    <span class="text-accent"> Competitive Edge</span>
                </h2>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div
                    class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm"
                >
                    <div
                        class="bg-accent/10 w-12 h-12 rounded-lg flex items-center justify-center mb-4"
                    >
                        <Star class="w-6 h-6 text-accent" />
                    </div>
                    <h3 class="font-bold text-primary mb-2">Local Trust</h3>
                    <p class="text-xs text-[var(--text-body)] leading-relaxed">
                        Most regional contractors don't understand {
                            city.name
                        }-specific codes. We've been local since day one.
                    </p>
                </div>
                <div
                    class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm"
                >
                    <div
                        class="bg-accent/10 w-12 h-12 rounded-lg flex items-center justify-center mb-4"
                    >
                        <Clock class="w-6 h-6 text-accent" />
                    </div>
                    <h3 class="font-bold text-primary mb-2">Rapid Response</h3>
                    <p class="text-xs text-[var(--text-body)] leading-relaxed">
                        strategic coverage across {city.county} means we're often
                        at your {city.name} door in under 60 minutes.
                    </p>
                </div>
                <div
                    class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm"
                >
                    <div
                        class="bg-accent/10 w-12 h-12 rounded-lg flex items-center justify-center mb-4"
                    >
                        <Shield class="w-6 h-6 text-accent" />
                    </div>
                    <h3 class="font-bold text-primary mb-2">
                        Bonded & Insured
                    </h3>
                    <p class="text-xs text-[var(--text-body)] leading-relaxed">
                        Full $2M liability coverage for every {service.name} project
                        in {city.name}. Total peace of mind.
                    </p>
                </div>
                <div
                    class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm"
                >
                    <div
                        class="bg-accent/10 w-12 h-12 rounded-lg flex items-center justify-center mb-4"
                    >
                        <CheckCircle class="w-6 h-6 text-accent" />
                    </div>
                    <h3 class="font-bold text-primary mb-2">Code Experts</h3>
                    <p class="text-xs text-[var(--text-body)] leading-relaxed">
                        We specialize in {city.county} County permits and {
                            regulatoryInfo.jurisdiction
                        } coordination.
                    </p>
                </div>
            </div>
        </Container>
    </section>

    <!-- Service Process Section -->
    {
        service.process && service.process.length > 0 && (
            <section
                class="bg-light"
                style="padding-top: var(--spacing-2xl); padding-bottom: var(--spacing-2xl);"
            >
                <Container>
                    <div class="text-center mb-12">
                        <span class="text-accent font-bold uppercase tracking-widest text-sm mb-4 block">
                            How It Works
                        </span>
                        <h2 class="text-3xl md:text-4xl font-black text-primary uppercase">
                            Our {city.name}{" "}
                            <span class="text-accent">{service.name}</span>{" "}
                            Process
                        </h2>
                    </div>

                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {service.process
                            .slice(0, 6)
                            .map(
                                (step: {
                                    step: number;
                                    title: string;
                                    description: string;
                                }) => (
                                    <div class="bg-white rounded-xl p-6 border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                                        <div class="w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center mb-4">
                                            <span class="text-accent font-black text-lg">
                                                {step.step}
                                            </span>
                                        </div>
                                        <h3 class="font-bold text-primary text-lg mb-2">
                                            {step.title}
                                        </h3>
                                        <p class="text-[var(--text-body)] text-sm leading-relaxed">
                                            {step.description}
                                        </p>
                                    </div>
                                ),
                            )}
                    </div>
                </Container>
            </section>
        )
    }

    <!-- Benefits Section -->
    {
        service.benefits && service.benefits.length > 0 && (
            <section
                class="bg-white"
                style="padding-top: var(--spacing-2xl); padding-bottom: var(--spacing-2xl);"
            >
                <Container>
                    <div class="text-center mb-12">
                        <span class="text-accent font-bold uppercase tracking-widest text-sm mb-4 block">
                            Why It Matters
                        </span>
                        <h2 class="text-3xl md:text-4xl font-black text-primary uppercase">
                            Benefits of {service.name}
                            <span class="text-accent"> in {city.name}</span>
                        </h2>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        {service.benefits.map(
                            (benefit: {
                                title: string;
                                description: string;
                                icon?: string;
                            }) => (
                                <div class="flex gap-4 p-6 bg-light rounded-xl border border-gray-100">
                                    <div class="w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <Zap class="w-6 h-6 text-accent" />
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-primary text-lg mb-2">
                                            {benefit.title}
                                        </h3>
                                        <p class="text-[var(--text-body)] text-sm leading-relaxed">
                                            {benefit.description}
                                        </p>
                                    </div>
                                </div>
                            ),
                        )}
                    </div>
                </Container>
            </section>
        )
    }

    <!-- FAQs Section -->
    {
        combinedFaqs.length > 0 && (
            <section
                class="bg-light"
                style="padding-top: var(--spacing-2xl); padding-bottom: var(--spacing-2xl);"
            >
                <Container>
                    <div class="text-center mb-12">
                        <span class="text-accent font-bold uppercase tracking-widest text-sm mb-4 block">
                            Common Questions
                        </span>
                        <h2 class="text-3xl md:text-4xl font-black text-primary uppercase">
                            {service.name} FAQs
                            <span class="text-accent"> for {city.name}</span>
                        </h2>
                    </div>

                    <!-- Inline FAQ Accordion -->
                    <div class="space-y-4 max-w-4xl mx-auto">
                        {combinedFaqs.slice(0, 6).map((faq: { question: string; answer: string }, index: number) => (
                            <div class="faq-item group relative bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-md hover:border-accent/30 transition-all duration-300 overflow-hidden">
                                <button
                                    class="faq-question w-full text-left p-5 md:p-6 flex items-center gap-4"
                                    data-index={`city-${index}`}
                                    aria-expanded="false"
                                >
                                    <span class="flex-1 font-bold text-primary group-hover:text-accent transition-colors duration-300 font-secondary uppercase tracking-tight text-sm md:text-base">
                                        {faq.question}
                                    </span>
                                    <div class="faq-icon flex-shrink-0 w-8 h-8 flex items-center justify-center bg-primary group-hover:bg-accent transition-all duration-300 rounded-lg">
                                        <span class="text-white font-bold text-xl leading-none transition-transform duration-300">+</span>
                                    </div>
                                </button>
                                <div
                                    class="faq-answer overflow-hidden transition-all duration-300 ease-in-out"
                                    style="max-height: 0;"
                                    data-index={`city-${index}`}
                                >
                                    <div class="px-5 md:px-8 pb-5 md:pb-8 text-[var(--text-body)] leading-relaxed border-t border-gray-100 pt-4 text-sm md:text-base">
                                        {faq.answer}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </Container>
            </section>
        )
    }

    <!-- Neighborhoods & Local Trust -->
    <section
        class="bg-white border-t border-gray-100"
        style="padding-top: var(--spacing-3xl); padding-bottom: var(--spacing-3xl);"
    >
        <Container>
            <div class="grid lg:grid-cols-2 gap-16 items-center">
                <div>
                    <span
                        class="text-accent font-bold uppercase tracking-widest text-sm mb-4 block"
                    >
                        Nearby Presence
                    </span>
                    <h2
                        class="text-3xl md:text-4xl font-black text-primary uppercase mb-6"
                    >
                        Serving All {city.name}
                        <span class="text-accent"> Neighborhoods</span>
                    </h2>
                    <p class="text-[var(--text-body)] text-lg mb-8">
                        Our technicians are active throughout {city.name},
                        providing {service.name} to residential and commercial properties.
                        From the city center to the surrounding areas, we know the
                        local requirements of your specific community.
                    </p>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        {
                            (city.neighborhoods || [])
                                .slice(0, 12)
                                .map((neighborhood: string) => (
                                    <div class="flex items-center gap-2 text-primary font-bold text-sm uppercase">
                                        <div class="w-1.5 h-1.5 bg-accent rounded-full" />
                                        {neighborhood}
                                    </div>
                                ))
                        }
                    </div>
                </div>

                <div
                    class="bg-light p-8 rounded-3xl border border-gray-100 relative overflow-hidden"
                >
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-accent/5 rounded-full -mr-16 -mt-16"
                    >
                    </div>

                    <h3
                        class="text-xl font-bold text-primary uppercase mb-6 flex items-center gap-3"
                    >
                        <MapPin class="w-6 h-6 text-accent" />
                        Local Landmarks
                    </h3>
                    <p
                        class="text-sm text-[var(--text-body)] mb-6 leading-relaxed"
                    >
                        We provide expert electrical services near major {
                            city.name
                        } landmarks, ensuring efficient response times for all local
                        homeowners and business owners.
                    </p>
                    <div class="flex flex-wrap gap-2">
                        {
                            (city.landmarks || []).map((landmark: string) => (
                                <span class="px-3 py-1.5 bg-white rounded-lg border border-gray-200 text-[10px] font-black text-primary uppercase tracking-wider shadow-sm">
                                    {landmark}
                                </span>
                            ))
                        }
                    </div>
                    <div class="mt-8 pt-8 border-t border-gray-200">
                        <div class="flex items-center gap-4">
                            <div class="bg-primary text-white p-3 rounded-xl">
                                <Shield class="w-6 h-6" />
                            </div>
                            <div>
                                <p
                                    class="text-sm font-black text-primary uppercase tracking-tight"
                                >
                                    Verified Local Provider
                                </p>
                                <p class="text-xs text-[var(--text-body)]">
                                    Full coverage for {city.name} and surrounding
                                    communities in {city.county} County.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </Container>
    </section>

    <!-- Reviews -->
    <ReviewCarousel />

    <!-- Related Cities Section -->
    <section
        class="bg-white"
        style="padding-top: var(--spacing-2xl); padding-bottom: var(--spacing-2xl);"
    >
        <Container>
            <div class="text-center mb-10">
                <span
                    class="text-accent font-bold uppercase tracking-widest text-sm mb-4 block"
                >
                    Also Serving
                </span>
                <h2
                    class="text-2xl md:text-3xl font-black text-primary uppercase"
                >
                    {service.name}
                    <span class="text-accent"> in Nearby Cities</span>
                </h2>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                {
                    relatedCities.map((relatedCity) => (
                        <a
                            href={`/services/${serviceId}/${relatedCity.slug}`}
                            class="group flex items-center gap-2 p-4 bg-light rounded-lg border border-gray-100 hover:border-accent hover:shadow-md transition-all"
                        >
                            <MapPin class="w-4 h-4 text-accent flex-shrink-0" />
                            <span class="font-medium text-primary group-hover:text-accent transition-colors text-sm">
                                {relatedCity.name}
                            </span>
                        </a>
                    ))
                }
            </div>

            <div class="text-center mt-8">
                <Button
                    href={`/services/${serviceId}`}
                    variant="secondary"
                    size="md"
                    class="gap-2"
                >
                    View All {service.name} Locations
                    <ArrowRight class="w-4 h-4" />
                </Button>
            </div>
        </Container>
    </section>

    <!-- Related Services Section -->
    <section
        class="bg-light"
        style="padding-top: var(--spacing-2xl); padding-bottom: var(--spacing-2xl);"
    >
        <Container>
            <div class="text-center mb-10">
                <span
                    class="text-accent font-bold uppercase tracking-widest text-sm mb-4 block"
                >
                    More Services
                </span>
                <h2
                    class="text-2xl md:text-3xl font-black text-primary uppercase"
                >
                    Other Electrical Services
                    <span class="text-accent"> in {city.name}</span>
                </h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {
                    relatedServices.map((relatedService) => (
                        <a
                            href={`/services/${relatedService.slug}/${cityId}`}
                            class="group flex items-center justify-between p-5 bg-white rounded-xl border border-gray-100 hover:border-accent hover:shadow-md transition-all"
                        >
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center">
                                    <Zap class="w-5 h-5 text-accent" />
                                </div>
                                <span class="font-bold text-primary group-hover:text-accent transition-colors">
                                    {relatedService.name}
                                </span>
                            </div>
                            <ChevronRight class="w-5 h-5 text-gray-400 group-hover:text-accent transition-colors" />
                        </a>
                    ))
                }
            </div>

            <div class="text-center mt-8">
                <Button
                    href={`/service-areas/${cityId}`}
                    variant="secondary"
                    size="md"
                    class="gap-2"
                >
                    All Services in {city.name}
                    <ArrowRight class="w-4 h-4" />
                </Button>
            </div>
        </Container>
    </section>

    <!-- Final CTA -->
    <section
        class="bg-gradient-to-br from-primary to-primary/95"
        style="padding-top: var(--spacing-3xl); padding-bottom: var(--spacing-3xl);"
    >
        <Container class="text-center">
            <Zap class="w-16 h-16 text-accent mx-auto mb-6 animate-pulse" />
            <h2
                class="text-3xl md:text-5xl font-black text-white uppercase mb-6"
            >
                Ready for {service.name}
                <span
                    class="block text-transparent bg-clip-text bg-gradient-to-r from-accent to-white"
                >
                    in {city.name}?
                </span>
            </h2>
            <p class="text-gray-200 text-lg md:text-xl mb-10">
                Get expert electrical service from {city.name}'s trusted
                electricians. Licensed, insured, and available 24/7 for your
                electrical needs.
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <CtaButton
                    action="call"
                    variant="secondary"
                    size="lg"
                    text="Call Now"
                />
                <Button href="/book" variant="primary" size="lg" class="gap-2">
                    <Zap class="w-5 h-5" />
                    Book Online
                </Button>
            </div>
        </Container>
    </section>

<!-- FAQ Accordion Script -->
<script>
    // FAQ Accordion Logic for inline FAQs
    document.addEventListener('DOMContentLoaded', () => {
        const faqQuestions = document.querySelectorAll('.faq-question');

        faqQuestions.forEach((question) => {
            question.addEventListener('click', () => {
                const index = question.getAttribute('data-index');
                const answer = document.querySelector(
                    `.faq-answer[data-index="${index}"]`
                ) as HTMLElement;
                const icon = question.querySelector('.faq-icon') as HTMLElement;
                const isExpanded =
                    question.getAttribute('aria-expanded') === 'true';
                const parentItem = question.closest('.faq-item');

                // Close all other FAQs
                faqQuestions.forEach((q) => {
                    const qIndex = q.getAttribute('data-index');
                    if (qIndex !== index) {
                        const qAnswer = document.querySelector(
                            `.faq-answer[data-index="${qIndex}"]`
                        ) as HTMLElement;
                        const qIcon = q.querySelector('.faq-icon') as HTMLElement;
                        const qParent = q.closest('.faq-item');

                        if (qAnswer) {
                            qAnswer.style.maxHeight = '0';
                        }
                        q.setAttribute('aria-expanded', 'false');
                        if (qIcon) {
                            qIcon.style.transform = 'rotate(0deg)';
                        }
                        qParent?.classList.remove('ring-2', 'ring-accent/30');
                    }
                });

                // Toggle current FAQ
                if (isExpanded) {
                    // Close it
                    if (answer) {
                        answer.style.maxHeight = '0';
                    }
                    question.setAttribute('aria-expanded', 'false');
                    if (icon) {
                        icon.style.transform = 'rotate(0deg)';
                    }
                    parentItem?.classList.remove('ring-2', 'ring-accent/30');
                } else {
                    // Open it
                    if (answer) {
                        answer.style.maxHeight = answer.scrollHeight + 'px';
                    }
                    question.setAttribute('aria-expanded', 'true');
                    if (icon) {
                        icon.style.transform = 'rotate(45deg)';
                    }
                    parentItem?.classList.add('ring-2', 'ring-accent/30');
                }
            });
        });
    });
</script>
</Layout>
